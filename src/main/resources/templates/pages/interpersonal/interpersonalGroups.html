<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Groups')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: vertical}"></div>
<main class="bg-body px-0 d-flex flex-column" style="height:100vh;margin-left:60px;">
    <nav class="px-4 pt-4" id="header-container" style="border-bottom: 1px #495057 solid;">
        <div class="row mb-2">
            <div class="col-md-10 d-flex flex-row align-items-center justify-content-start">
                <img class="square-image me-2" style="height: 80px; width: 80px" alt="group image" th:src="@{/icons/Default Group.svg}" id="group-image">
                <h1 class="fw-bold" id="group-name">Name</h1>
            </div>
            <div class="col-md-2 mb-2 d-flex flex-column align-items-start justify-content-center">
                <label for="group-form">Select Group</label>
                <div class="input-group">
                    <select class="form-select" id="group-form"></select>
                    <button class="btn btn-primary bevel-sm" type="button" onclick="selectGroup()">Change</button>
                </div>
            </div>
        </div>
        <p class="fs-5 mb-2" id="group-description">Description</p>
        <p id="last-modified" class="mb-0"></p>

        <div class="mb-0 pb-0 mt-4 d-flex justify-content-between align-items-end">
            <ul class="nav nav-underline" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fs-3 p-0" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Members</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fs-3 p-0" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-tab-pane" type="button" role="tab" aria-controls="events-tab-pane" aria-selected="false">Events</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fs-3 p-0" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-tab-pane" type="button" role="tab" aria-controls="analysis-tab-pane" aria-selected="false">Statistics</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fs-3 p-0" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-tab-pane" type="button" role="tab" aria-controls="network-tab-pane" aria-selected="false">Network</button>
                </li>
            </ul>
            <div class="d-flex flex-row align-content-center justify-content-end pb-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#saveGroupModal" onclick="updateEditGroupModal()">Edit Group</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#member-modal" onclick="renderGroupMemberSelectModal()">Manage Members</button>
                <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#saveGroupModal" onclick="resetEditGroupModal()">+ New Group</button>
            </div>
        </div>
    </nav>
    <div class="p-4 h-100">
        <div class="tab-content h-100" id="myTabContent">
            <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                <div class="row" id="main-content">
                    <div class="d-flex justify-content-center col-12">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h3 class="text-center fw-bold">Please Wait</h3>
                </div>
            </div>
            <div class="tab-pane fade" id="events-tab-pane" role="tabpanel" aria-labelledby="events-tab" tabindex="0">
                <p class="fs-4" id="event-status"></p>
                <div id="timeline-container"></div>
            </div>
            <div class="tab-pane fade" id="analysis-tab-pane" role="tabpanel" aria-labelledby="analysis-tab" tabindex="0">
                <div class="row mt-3">
                    <div class="col-lg-3 col-12 mb-3">
                        <div class="px-3 py-3 rounded-3 bg-dark h-100">
                            <h4 class="fw-bold text-center mb-2">Group Relationships</h4>
                            <canvas id="composition-canvas" style="display: block; box-sizing: border-box; height: 324px; width: 324px;"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-3 col-12 mb-3">
                        <div class="px-3 py-3 rounded-3 bg-dark h-100">
                            <h4 class="fw-bold text-center mb-2">Group Sexes</h4>
                            <canvas id="gender-canvas" style="display: block; box-sizing: border-box; height: 324px; width: 324px;"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="px-3 py-3 rounded-3 bg-dark d-flex justify-content-around h-100">
                            <div>
                                <h5 class="fw-bold text-center">Average Edits</h5>
                                <p class="fs-4 text-center mb-0 mt-3" id="av-edits">E</p>
                            </div>
                            <div>
                                <h5 class="fw-bold text-center">Total Edits</h5>
                                <p class="fs-4 text-center mb-0 mt-3" id="tot-edits">E</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade flex-grow-1 h-100" id="network-tab-pane" role="tabpanel" aria-labelledby="network-tab-pane" tabindex="0">
                <div class="h-100" id="network-container"></div>
                <div class="position-absolute bottom-0 end-0 bg-body-tertiary p-3 m-3 d-flex flex-row gap-2">
                    <button type="button" class="btn bg-light-subtle d-flex justify-content-center align-items-center p-2" data-bs-toggle="tooltip" data-bs-title="Reset View" onclick="cy.reset()">
                        <img class="square-image" src="/icons/Reset%20Zoom.svg" alt="refresh" style="width: 30px;">
                    </button>
                    <button type="button" class="btn bg-light-subtle d-flex justify-content-center align-items-center p-2" data-bs-toggle="modal" data-bs-target="#graph-modal">
                        <img class="square-image" src="/icons/Settings.svg" alt="refresh" style="width: 30px;">
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="saveGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="saveGroupModalTitle">Save Group</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h4 class="fw-bold text-center" id="recent-score-modal"></h4>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="pfp-file" class="form-label">Upload group icon</label>
                        <input class="form-control" type="file" name="file" accept="image/*" id="pfp-file">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="group-title-form" class="form-label">Title</label>
                        <input type="text" class="form-control" id="group-title-form" required>
                    </div>
                    <div class="col-12">
                        <label for="group-description-form" class="form-label">Description</label>
                        <textarea class="form-control" id="group-description-form" rows="3"></textarea>
                    </div>
                    <div class="col-12 mt-3">
                        <label for="color-preview" class="form-label">Color</label>
                        <div class="container" style="height:40px" id="color-preview"></div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-red-form">Red</label>
                            <input type="number" class="form-control" id="group-red-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-green-form">Green</label>
                            <input type="number" class="form-control" id="group-green-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-blue-form">Blue</label>
                            <input type="number" class="form-control" id="group-blue-form">
                        </div>
                    </div>
                    <input type="hidden" id="group-id-form" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="modalSaveGroup()" data-bs-dismiss="modal">Save Group</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" aria-labelledby="be" id="member-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="be">Add/Remove Members</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p>Please choose the members you would like to add or remove to the currently selected group.</p>
                    </div>
                    <div class="col-12">
                        <div class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                                        Included Members
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-included">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                        Members Not Included
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-not-included">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" aria-labelledby="be" id="member-modal-2">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Add/Remove Members from Event</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p>Please choose the members you would like to add or remove to the selected event. This list includes all members in the group.</p>
                    </div>
                    <div class="col-12">
                        <div class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                                        Included Members
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-included-2">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseFour" aria-expanded="false" aria-controls="panelsStayOpen-collapseFour">
                                        Members Not Included
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseFour" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-not-included-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="relationship-modal" tabindex="-1" aria-labelledby="relationship-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="relationship-modal-label">Create / Edit Relationship</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to edit the one-way relationship between two Polariscope members. Please review carefully and proceed</p>
                <div class="d-flex flex-row gap-3 align-items-center justify-content-center py-3 my-2" style="background: linear-gradient(#222, #333); border-bottom: 1px #495057 solid; border-top: 1px #495057 solid;">
                    <div class="d-flex flex-column align-items-center">
                        <img id="modal-person-1-img" class="profile-image" alt="person 1" src="/icons/Default%20User.svg" width="100px" />
                        <p id="modal-person-1-name" class="mb-0 fw-bold">Person 1</p>
                    </div>
                    <img src="/icons/Arrow.svg" class="mx-3" style="transform: rotate(-90deg)" width="70px" alt="Arrow pointing right" />
                    <div class="d-flex flex-column align-items-center">
                        <img id="modal-person-2-img" class="profile-image" alt="person 2" src="/icons/Default%20User.svg" width="100px" />
                        <p id="modal-person-2-name" class="mb-0 fw-bold">Person 2</p>
                    </div>
                </div>
                <div class="d-flex flex-row justify-content-between">
                    <p id="modal-relationship-health"></p>
                    <p id="modal-relationship-type"></p>
                </div>
                <div class="mt-2">
                    <p class="fs-4 fw-bold">Relationship Details</p>
                    <div class="mb-3">
                        <label for="modal-relationship-type-form">Relationship Type</label>
                        <select class="form-select" id="modal-relationship-type-form" name="relationship" required>
                            <option value="" disabled>Select Relationship Type</option>
                            <th:block th:each="relationshipType : ${relationshipTypes}">
                                <option th:value="${relationshipType}" th:text="${relationshipType.toString().toLowerCase()}"></option>
                            </th:block>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="modal-relationship-health-form" class="form-label">Relationship Health</label>
                        <input type="number" class="form-control" id="modal-relationship-health-form" required>
                    </div>

                    <div class="mb-3">
                        <label for="modal-relationship-description" class="form-label">Description</label>
                        <textarea class="form-control" id="modal-relationship-description" rows="3"></textarea>
                    </div>

                    <input type="hidden" id="modal-self" />
                    <input type="hidden" id="modal-other" />

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" data-bs-dismiss="modal" onclick="saveRelationship()">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="network-modal" tabindex="-1" aria-labelledby="network-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="network-modal-label">Quick View</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex flex-row gap-3 align-items-center justify-content-center p-4 mt-2 gap-3" style="background: linear-gradient(#222, #333); border-top: 1px #495057 solid;">
                    <img id="modal-poi-image" class="profile-image" alt="person of interest" src="/icons/Default%20User.svg" width="100px" />
                    <div class="d-flex flex-column align-items-start justify-content-start">
                        <p id="modal-poi-name" class="fs-4 mb-0 fw-bold">Person of Interest</p>
                        <p id="modal-poi-type" class="mb-0">Association</p>
                        <p id="modal-poi-score" class="mb-0">prev score</p>
                    </div>
                </div>
                <div class="d-flex flex-row justify-content-center align-items-center p-2 mt-1" style="background: #333; border-bottom: 1px #495057 solid;">
                    <p id="modal-poi-centrality" class="mb-0 fw-bold">prev score</p>
                </div>
            </div>
            <div class="modal-footer">
                <div id="modal-poi-action-button"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="graph-modal" tabindex="-1" aria-labelledby="graph-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="graph-modal-label">Graph Settings</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column gap-2">
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Show Profile Images</h4>
                    <p>Shows profile images on top of each node representing a member if applicable.</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="graph-checkbox-img">
                        <label class="form-check-label" for="graph-checkbox-img">
                            Show profile images
                        </label>
                    </div>
                </div>
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Show Names</h4>
                    <p>Display member names as labels on each node.</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="graph-checkbox-labels" checked>
                        <label class="form-check-label" for="graph-checkbox-labels">
                            Show names
                        </label>
                    </div>
                </div>
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Relationship Strength</h4>
                    <p>Displays edges that have an absolute value of above the given amount.</p>
                    <div class="d-flex flex-row justify-content-start align-items-center">
                        <p id="tolerance-indicator" style="width: 40px" class="text-center">0</p>
                        <div class="form-check p-0 flex-grow-1">
                            <label for="graph-range-show" class="form-label">Tolerance level</label>
                            <input type="range" class="form-range" min="0" max="100" id="graph-range-show" onchange="updateToleranceIndicator()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="renderGraph()" data-bs-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{components/Gradient :: gradient}"></div>
<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/External :: tooltips}"></div>
<div th:replace="~{components/Network :: network}"></div>
<div th:replace="~{components/Network :: data-upload}"></div>
<div th:replace="~{components/Toast :: toast}"></div>
<div th:replace="~{components/Formatting :: timestamp-formatting}"></div>
<script src="/external/cytoscape.min.js"></script>

<script>
    let currentGroupId;
    let enums, fullMemberList, groupMemberList, memberRelationships;
    let memberCompositionChart, sexCompositionChart;

    // Graph variables
    let cy = cytoscape({

        container: document.getElementById('network-container'),

        style: [ // the stylesheet for the graph
            {
                selector: 'node',
                style: {
                    'background-color': 'data(color)',
                    'label': 'data(name)',
                    'color': 'white',
                    'text-wrap': 'ellipsis',
                    'background-opacity': 'data(opacity)',
                    'shape': 'data(shape)',
                    'background-image': 'data(img)',
                    'background-image-opacity': 'data(imgOpacity)',
                    'background-fit': 'contain'
                }
            },

            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': 'data(color)',
                    'target-arrow-color': 'data(color)',
                    'target-arrow-shape': 'chevron',
                    'curve-style': 'bezier',
                    'opacity': 'data(opacity)'
                }
            }
        ],
    });
    document.querySelector("#graph-range-show").value = 0;

    refresh();
    function refresh(){
        const enumFetch = fetch("/api/interpersonal/enums", {});
        const memberListFetch = fetch("/api/interpersonal/member/all", {});
        const relFetch = fetch("/api/interpersonal/relationship/all", {});

        Promise.all([enumFetch, memberListFetch, relFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json(), data[1].json(), data[2].json()]);
            })
            .then(data => {
                enums = data[0];
                fullMemberList = data[1];
                memberRelationships = data[2].sort((a, b) => a.id.localeCompare(b.id));

                if(enums.groups.length === 0){
                    document.querySelector("#main-content").innerHTML = "<h2 class='text-center fw-bold mt-2'>No groups to display</h2><p class='text-center'>Create one in settings or the new group button</p>";
                }else{
                    renderDropdown();
                    selectGroup();
                }
            })
            .catch((response) => {
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            });
    }

    function renderDropdown(){
        let content = ``;

        enums.groups.forEach((group, index) => {
            content += `<option value="${group.id}">${group.name}</option>`;
        });

        document.querySelector("#group-form").innerHTML = content;
    }

    function selectGroup(){
        currentGroupId = document.querySelector("#group-form").value;
        const memberDetailFetch = fetch("/api/interpersonal/member/group/" + currentGroupId, {});
        Promise.all([memberDetailFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                groupMemberList = data[0];
                renderBody();
                renderGraph();
            })
            .catch((response) => {
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            })
            .finally(() => {
                tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
                tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
            });
    }

    function renderBody(){
        const currentGroup = getCurrentGroup(currentGroupId)
        // render header
        document.querySelector("#header-container").style.background = `linear-gradient(to top right, rgb(${currentGroup.color.red}, ${currentGroup.color.green}, ${currentGroup.color.blue},.3), rgb(${currentGroup.color.red}, ${currentGroup.color.green}, ${currentGroup.color.blue},.05))`;
        document.querySelector("#group-description").textContent = currentGroup.description;
        document.querySelector("#group-name").textContent = currentGroup.name;
        document.querySelector("#group-image").src = `/api/interpersonal/group/image/${currentGroup.id}?=${new Date().getTime()}`;
        document.querySelector("#last-modified").innerText = "Members: " + currentGroup.numMembers + " - Last modified: " + formatTimestamp(currentGroup.lastModified);

        // Render body
        let memberListContent = ``;
        let editCountTotal = 0;
        let allEventsCombined = [];

        groupMemberList.forEach((member) => {
            allEventsCombined.push(...member.events);
            editCountTotal += member.editCount;

            memberListContent += `
                        <a class="col-6 col-md-3 col-lg-2 p-2 d-flex flex-column" href="/interpersonal/member/view/${member.id}">
                            <img class="square-image w-100 p-3" alt="Member image" src="/api/interpersonal/member/profile-image/${member.id}">
                            <p class="text-center text-white fs-4 fw-bold text-nowrap text-truncate">${member.firstName + ' ' + member.lastName}</p>
                        </a>
                    `;
        });

        document.querySelector("#av-edits").textContent = editCountTotal / groupMemberList.length;
        document.querySelector("#tot-edits").textContent = editCountTotal;

        document.querySelector("#main-content").innerHTML = memberListContent;

        // Event content
        const allEvents = allEventsCombined.reduce((acc, current) => {
            const exists = acc.find(item => item.id === current.id);
            if (!exists) {
                acc.push(current);
            }
            return acc;
        }, []);

        allEvents.sort((a, b) => {
            return new Date(b.date) - new Date(a.date)
        });
        
        document.querySelector("#event-status").innerText = allEvents.length + " total events with " + groupMemberList.length + " members";
        let eventContent = ``;
        allEvents.forEach((event) => {
            //loop to gather members who have this event
            let memberContent = "";
            groupMemberList.forEach((m) => {
                if(m.events.some(obj => obj.id === event.id)){
                    memberContent += `
                <a href="/interpersonal/member/view/${m.id}">
                    <img class="square-image" style="height: 40px; width: 40px" alt="profile image" src="/api/interpersonal/member/profile-image/${m.id}" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="${m.firstName + " " + m.lastName}">
                </a>
                `;
                }
            });

            let eventHTML = `
            <div class="alert alert-secondary mt-2" style="background: linear-gradient(to top right, rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.03), rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.15))">
                <div class="d-flex flex-row justify-content-between align-items-center">
                    <p class="fs-4 fw-bold text-white">${event.label}</p>
                    <p class="fw-bold text-white">${formatTimestamp(event.date)}</p>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#network-modal-2" style="background-color: rgba(200,200,200,.3)" onclick="renderEventMemberModal('${event.id}')">Manage Members</button>
                </div>
                <p class="fs-5 text-white">${event.description.length > 0? event.description : "No description given"}</p>
                <div class="d-flex flex-row justify-content-end align-items-center gap-2">
                    ${memberContent}
                </div>
            </div>
            `;
            eventContent += eventHTML;
        });
        document.querySelector("#timeline-container").innerHTML = eventContent;

        // Update graphs
        updateGraph();

        // Update member select modal
        renderGroupMemberSelectModal();
    }

    setupGraph();
    function setupGraph(){
        let canvas = document.querySelector("#composition-canvas");
        let data = {
            datasets: [{
                data:[]
            }],
            labels:[]
        };
        memberCompositionChart = new Chart(canvas, {
            type: 'doughnut',
            data:data,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        let canvas2 = document.querySelector("#gender-canvas");
        let data2 = {
            datasets: [{
                data:[]
            }],
            labels:[]
        };
        sexCompositionChart = new Chart(canvas2, {
            type: 'doughnut',
            data:data2,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function updateGraph(){
        const relations = groupMemberList.reduce((acc, obj) => {
            const type = obj.relationship;
            if (acc[type]) {
                acc[type]++;
            } else {
                acc[type] = 1;
            }
            return acc;
        }, {});

        const sexes = groupMemberList.reduce((acc, obj) => {
            const type = obj.sex;
            if (acc[type]) {
                acc[type]++;
            } else {
                acc[type] = 1;
            }
            return acc;
        }, {});


        const labels = Object.keys(relations);
        const values = Object.values(relations);

        let data = {
            datasets: [{
                data:values
            }],
            labels:labels
        };

        memberCompositionChart.data = data;
        memberCompositionChart.update();

        const labels2 = Object.keys(sexes);
        const values2 = Object.values(sexes);

        let data2 = {
            datasets: [{
                data:values2
            }],
            labels:labels2
        };

        sexCompositionChart.data = data2;
        sexCompositionChart.update();
    }

    function getCurrentGroup(id){
        return enums.groups.find(g => g.id === id);
    }

    // Modals
    function updateEditGroupModal(){
        const group = getCurrentGroup(currentGroupId);
        document.querySelector("#group-description-form").value = group.description;
        document.querySelector("#group-id-form").value = currentGroupId;
        document.querySelector("#group-title-form").value = group.name;
        document.querySelector("#group-red-form").value = group.color.red;
        document.querySelector("#group-green-form").value = group.color.green;
        document.querySelector("#group-blue-form").value = group.color.blue;
        document.querySelector("#saveGroupModalTitle").innerText = "Edit Group";
        updateEditGroupModalColor();
    }

    function updateEditGroupModalColor(){
        const color = "rgb(" + document.querySelector("#group-red-form").value + "," + document.querySelector("#group-green-form").value + "," + document.querySelector("#group-blue-form").value + ")";
        console.log(color);
        document.querySelector("#color-preview").style.backgroundColor = color;
    }

    function resetEditGroupModal(){
        document.querySelector("#group-description-form").value = "";
        document.querySelector("#group-id-form").value = "";
        document.querySelector("#group-title-form").value = "";
        document.querySelector("#saveGroupModalTitle").innerText = "New Group";
        document.querySelector("#group-red-form").value = Math.floor(Math.random() * 256);
        document.querySelector("#group-green-form").value = Math.floor(Math.random() * 256);
        document.querySelector("#group-blue-form").value = Math.floor(Math.random() * 256);
        updateEditGroupModalColor();
    }

    function renderGroupMemberSelectModal(){
        const notIncludedContainer = document.querySelector("#member-list-not-included");
        const includedContainer = document.querySelector("#member-list-included");
        let notIncluded = "", included = "";

        fullMemberList.forEach((member) => {
            let element = `<button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2" onclick="toggleGroup('${member.id}')">
                                <div class="d-flex justify-content-start gap-2 align-items-center">
                                    <img class="square-image img-fluid" style="width: 20px; height: 20px;" alt="pfp" src="/api/interpersonal/member/profile-image/${member.id}" />
                                    <p class="mb-0 fw-bold ms-2">${member.firstName} ${member.lastName}</p>
                                </div>
                            </button>`;

            if(member.group !== null && member.group.id === currentGroupId){
                included += element;
            }else{
                notIncluded += element;
            }
        });
        notIncludedContainer.innerHTML = notIncluded;
        includedContainer.innerHTML = included;
    }

    function toggleGroup(memberId){
        const member = fullMemberList.find(g => g.id === memberId);

        const toggle = member.group == null || member.group.id.trim() !== currentGroupId.trim() ? currentGroupId : "";

        const form = {
            memberId: memberId,
            groupId: toggle
        };

        let toastId = createToast("Saving Member Details");
        postData("/api/interpersonal/member/change-group", form)
            .then((message) => {
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-title`).innerText =  message.title;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
            });
    }

    document.querySelector("#group-red-form").addEventListener('input', function() {
        updateEditGroupModalColor();
    });
    document.querySelector("#group-green-form").addEventListener('input', function() {
        updateEditGroupModalColor();
    });
    document.querySelector("#group-blue-form").addEventListener('input', function() {
        updateEditGroupModalColor();
    });

    function renderEventMemberModal(id){
        const groupFetch = fetch("/api/interpersonal/member/group/" + currentGroupId, {});
        Promise.all([groupFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                const notIncludedContainer = document.querySelector("#member-list-not-included-2");
                const includedContainer = document.querySelector("#member-list-included-2");
                let notIncluded = "", included = "";

                data[0].forEach((member) => {
                    let element = `<button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2" onclick="toggleEvent('${member.id}', '${id}')">
                                <div class="d-flex justify-content-start gap-2 align-items-center">
                                    <img class="square-image img-fluid" style="width: 20px; height: 20px;" alt="pfp" src="/api/interpersonal/member/profile-image/${member.id}" />
                                    <p class="mb-0 fw-bold ms-2">${member.firstName} ${member.lastName}</p>
                                </div>
                            </button>`;

                    if(member.events.some(obj => obj.id === id)){
                        included += element;
                    }else{
                        notIncluded += element;
                    }
                });
                notIncludedContainer.innerHTML = notIncluded;
                includedContainer.innerHTML = included;
            })
            .catch((response) => {
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            });
    }

    // Database functionality
    function saveRelationship(next=false){
        let data = {
            self: document.querySelector("#modal-self").value,
            other: document.querySelector("#modal-other").value,
            health: document.querySelector("#modal-relationship-health-form").value,
            type: document.querySelector("#modal-relationship-type-form").value,
            description: document.querySelector("#modal-relationship-description").value
        }

        let errorIcon = document.querySelector("#error-icon");
        let toastId = createToast("Updating Relationship");
        postData("/api/interpersonal/relationship/save", data)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";

                if(next){
                    let otherIndex = allMembers.findIndex((m) => m.id === data.other)
                    let nextIndex = (otherIndex+1) % allMembers.length;
                    if(allMembers[nextIndex].id === data.self){
                        nextIndex = (otherIndex+2) % allMembers.length;
                    }
                    renderModal(data.self, allMembers[nextIndex].id);
                }
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to edit relationship";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
            });
    }

    function modalSaveGroup(){
        const formData = new FormData();

        const imageFile = document.getElementById('pfp-file').files[0];
        formData.append('image', imageFile);

        formData.append('id',           document.querySelector("#group-id-form").value);
        formData.append('description',  document.querySelector("#group-description-form").value);
        formData.append('name',         document.querySelector("#group-title-form").value);
        formData.append('red',          document.querySelector("#group-red-form").value);
        formData.append('green',        document.querySelector("#group-green-form").value);
        formData.append('blue',         document.querySelector("#group-blue-form").value);

        let toastId = createToast("Saving Group");
        postDataWithFile("/api/interpersonal/group/save", formData)
            .then((message) => {
                message.json()
                    .then(messageData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(messageData.severity) + messageData.message;
                        document.getElementById(`${toastId}-title`).innerText =  messageData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "green";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {refresh()});
    }

    function toggleEvent(memberId, eventId){
        const form = {
            memberId: memberId,
            eventId: eventId
        };

        let toastId = createToast("Saving Member Details");
        postData("/api/interpersonal/event/change-member", form)
            .then((message) => {
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-title`).innerText =  message.title;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                renderEventMemberModal(eventId);
                refresh();
            });
    }


    // Network rendering
    function renderGraph(){
        cy.nodes().remove();

        groupMemberList.forEach((member) => {
            let lastEval = member.lastEvaluation? member.lastEvaluation : member.mostRecentEval;
            cy.add({
                group: 'nodes',
                data: {id: member.id,
                    name: document.querySelector("#graph-checkbox-labels").checked? member.firstName + " " + member.lastName : "",
                    img: `/api/interpersonal/member/profile-image/${member.id}`,
                    imgOpacity: document.querySelector("#graph-checkbox-img").checked? "1" : "0",
                    opacity: 1,
                    shape: shapeMap(member.sex),
                    color: getColorGradient((lastEval === undefined ||  lastEval.cscore === null? "#333" : lastEval.cscore), -100, 100)}})
        });

        // Add in relationships
        if(document.querySelector("#group-form").value === ""){
            memberRelationships.filter((r) => Math.abs(r.health) >= document.querySelector("#graph-range-show").value).forEach((relationship) => {
                cy.add({ group: 'edges', data: { id: relationship.id, source: relationship.self.id, target: relationship.other.id, color: getColorGradient(relationship.health, -100, 100), opacity: Math.min(Math.max((Math.abs(relationship.health) / 100), .05), .9)} });
            });
        }else{
            memberRelationships.filter((r) => Math.abs(r.health) > document.querySelector("#graph-range-show").value).forEach((relationship) => {
                let person1 = groupMemberList.find((x) => x.id === relationship.self.id);
                let person2 = groupMemberList.find((x) => x.id === relationship.other.id);
                if(person1 && person2){
                    cy.add({ group: 'edges', data: { id: relationship.id, source: relationship.self.id, target: relationship.other.id, color: getColorGradient(relationship.health, -100, 100), opacity: Math.min(Math.max((Math.abs(relationship.health) / 100), .05), .9)} });
                }
            });
        }

        // Layout
        setTimeout(()=>{
            let main_layout = cy.nodes().layout({
                name: 'random',
                fit: true,
                animation: false
            });

            main_layout.run();
        }, 1000);

    }

    function renderMemberModal(id){
        let poi = groupMemberList.find((m) => m.id === id);
        if(poi){
            let lastEval = poi.lastEvaluation? poi.lastEvaluation : poi.mostRecentEval;

            document.querySelector("#modal-poi-image").src = `/api/interpersonal/member/profile-image/${id}`;
            document.querySelector("#modal-poi-name").textContent = poi.firstName + " " + poi.lastName;
            document.querySelector("#modal-poi-type").textContent = poi.relationship;

            if(lastEval !== undefined){
                document.querySelector("#modal-poi-score").textContent = lastEval.cscore + " | " + formatTimestamp(lastEval.timestamp);
            }else{
                document.querySelector("#modal-poi-score").textContent = "No score recorded";
            }

            document.querySelector("#modal-poi-centrality").textContent = "Centrality: " + cy.$().dc({root: '#' + id}).degree;
            document.querySelector("#modal-poi-action-button").innerHTML = `<a href="/interpersonal/member/view/${id}"><button type="button" class="btn btn-info" data-bs-dismiss="modal">View Member</button></a>`;
        }else{
            let group = enums.groups.find((g) => g.id === id);
            if(group !== undefined){
                document.querySelector("#modal-poi-image").src = `/api/interpersonal/group/image/${id}?=${new Date().getTime()}`;
                document.querySelector("#modal-poi-name").textContent = group.name;
                document.querySelector("#modal-poi-type").textContent = group.description;
                document.querySelector("#modal-poi-action-button").innerHTML = `<a href="/interpersonal/groups"><button type="button" class="btn btn-info" data-bs-dismiss="modal">View Groups</button></a>`;
                document.querySelector("#modal-poi-score").textContent = "";
                document.querySelector("#modal-poi-centrality").textContent = "Member Count: " + group.numMembers;
            }
        }
    }

    function renderModal(selfId, otherId){
        let self = groupMemberList.find((member) => member.id === selfId);
        let other = groupMemberList.find((member) => member.id === otherId);
        let relationship = memberRelationships.find((rel) => rel.id===`${self.id}${other.id}`);

        document.querySelector("#modal-person-1-name").textContent = self.firstName + " " + self.lastName;
        document.querySelector("#modal-person-2-name").textContent = other.firstName + " " + other.lastName;

        if(relationship){
            document.querySelector("#modal-relationship-health").textContent = `Relationship Health: ${relationship.health}`;
            document.querySelector("#modal-relationship-type").textContent = `Relationship Type: ${relationship.type}`;

            document.querySelector("#modal-relationship-health-form").value = relationship.health;
            document.querySelector("#modal-relationship-type-form").value = relationship.type;

            document.querySelector("#modal-relationship-description").value = relationship.description;
        }else{
            document.querySelector("#modal-relationship-health").textContent = "No relationship recorded";
            document.querySelector("#modal-relationship-type").textContent = "";

            document.querySelector("#modal-relationship-health-form").value = 0;
            //document.querySelector("#modal-relationship-type-form").value = "";

            document.querySelector("#modal-relationship-description").value = "";
        }

        document.querySelector("#modal-person-1-img").src = `/api/interpersonal/member/profile-image/${self.id}`;
        document.querySelector("#modal-person-2-img").src = `/api/interpersonal/member/profile-image/${other.id}`;

        document.querySelector("#modal-self").value = self.id;
        document.querySelector("#modal-other").value = other.id;
    }

    // Graph callbacks
    cy.on('dbltap', 'node', (event) => {
        renderMemberModal(event.target._private.data.id);
        let myModal = new bootstrap.Modal(document.getElementById('network-modal'));
        myModal.show();
    });

    cy.on('dbltap', 'edge', (event) => {
        renderModal(event.target._private.data.source, event.target._private.data.target);
        let myModal = new bootstrap.Modal(document.getElementById('relationship-modal'));
        myModal.show();
    });

    function updateToleranceIndicator(){
        document.querySelector('#tolerance-indicator').textContent = document.querySelector('#graph-range-show').value;
    }
    document.querySelector("#graph-range-show").value = 0;

    function shapeMap(sex){
        if(sex === "MALE"){
            return "rectangle";
        }else if(sex === "FEMALE"){
            return "ellipse";
        }else{
            return "triangle";
        }
    }
</script>
</body>
</html>