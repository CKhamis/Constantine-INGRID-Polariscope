<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Settings')}"></head>
<body class="stripe-white" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: vertical}"></div>

<main class="bg-body px-0 d-flex flex-column" style="height:100vh;margin-left:60px;">
    <nav class="bg-success-subtle p-4">
        <a onclick="displayMainMenu()" class="mt-5 text-success-emphasis">< Main Menu</a>
        <h1 class="fw-bold mb-0 text-success-emphasis" id="title">Constantine [IN]GRID Transfer Tool</h1>
    </nav>
    <div class="p-4 flex-grow-1 overflow-auto" id="main-content">
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <h3 class="text-center fw-bold">Please Wait</h3>
    </div>
    <nav style="bottom: 0; width: 100%" class="p-2 bg-body-tertiary d-flex flex-row align-items-center">
        <p th:text="${'Constantine Polariscope Version: ' + version}" class="text-center mb-0"></p>
    </nav>
</main>

<div class="modal fade" id="saveGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="saveGroupModalTitle">Save Group</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h4 class="fw-bold text-center" id="recent-score-modal"></h4>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="pfp-file" class="form-label">Upload group icon</label>
                        <input class="form-control" type="file" name="file" accept="image/*" id="pfp-file">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="group-title-form" class="form-label">Title</label>
                        <input type="text" class="form-control" id="group-title-form" required>
                    </div>
                    <div class="col-12">
                        <label for="group-description-form" class="form-label">Description</label>
                        <textarea class="form-control" id="group-description-form" rows="3"></textarea>
                    </div>
                    <div class="col-12 mt-3">
                        <label for="color-preview" class="form-label">Color</label>
                        <div class="container" style="height:40px" id="color-preview"></div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-red-form">Red</label>
                            <input type="number" class="form-control" id="group-red-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-green-form">Green</label>
                            <input type="number" class="form-control" id="group-green-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="group-blue-form">Blue</label>
                            <input type="number" class="form-control" id="group-blue-form">
                        </div>
                    </div>
                    <input type="hidden" id="group-id-form" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="modalSaveGroup()" data-bs-dismiss="modal">Save Group</button>
            </div>
        </div>
    </div>
</div>


<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Formatting :: date-formatting}"></div>
<div th:replace="~{components/External :: tooltips}"></div>
<div th:replace="~{components/Formatting :: timestamp-formatting}"></div>
<div th:replace="~{components/Network :: data-upload}"></div>
<div th:replace="~{components/Toast :: toast}"></div>
<div th:replace="~{components/Network :: network}"></div>
<script>
    let enums;

    displayMainMenu();
    function displayMainMenu(){
        document.querySelector("#title").textContent = `Polariscope Settings`;
        document.querySelector("#main-content").innerHTML = `
        <div class="row">
            <div class="col-lg-2"></div>
            <div class="col-lg-4 px-5 mb-3" onclick="displayMemberSettings()" role="button">
                <div class="bg-body-tertiary bevel-lg d-flex align-items-center flex-column p-3">
                    <img class="card-img-top square-image mt-2" alt="inspect members" src="/icons/Inspect.svg">
                    <h3 class="fw-bold text-center mt-3">Member Settings</h3>
                </div>
            </div>
            <div class="col-lg-4 px-5" onclick="displayUserSettings()" role="button">
                <div class="bg-body-tertiary bevel-lg d-flex align-items-center flex-column p-3">
                    <img class="card-img-top square-image mt-2" alt="inspect members" src="/icons/Wrench.svg">
                    <h3 class="fw-bold text-center mt-3">User Settings</h3>
                </div>
            </div>
        </div>
        `;
    }

    function displayMemberSettings(){
        document.querySelector("#main-content").innerHTML = `
        <div class="col-lg-2 d-none d-lg-block"></div>
        <div class="col-lg-8 col-12">
            <div class="row">
                <a class="col-md-6 col-lg-4 mb-4 px-3" href="/interpersonal/import">
                    <div class="bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button">
                        <p class="fs-4 fs-bold text-center m-0">Import Members</p>
                    </div>
                </a>
            </div>
        </div>

        `;
        document.querySelector("#title").textContent = `Polariscope Settings > Member Settings`;
    }

    function displayUserSettings(){
        let content = "";
        const userFetch = fetch('/api/account/info/current')
        Promise.all([userFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                let ownerSettings = "";
                if(data[0].authorities[0].authority === "Owner"){
                    ownerSettings = `
                        <a class="col-md-4 col-lg-3 mb-4 px-3" onclick="displayNewUser()">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button">
                                <p class="fs-4 fs-bold text-center m-0">New User</p>
                            </div>
                        </a>
                    `
                }
                content = `
                <div class="col-12">
                    <div class="row">
                        <a class="col-md-4 col-lg-3 mb-4 px-3" onclick="displayActivity()">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button">
                                <p class="fs-4 fs-bold text-center m-0">User Activity</p>
                            </div>
                        </a>
                        <a class="col-md-4 col-lg-3 mb-4 px-3" href="/tutorial">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button">
                                <p class="fs-4 fs-bold text-center m-0">Tutorial</p>
                            </div>
                        </a>
                        <a class="col-md-4 col-lg-3 mb-4 px-3" onclick="displayGroups()">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button">
                                <p class="fs-4 fs-bold text-center m-0">Groups</p>
                            </div>
                        </a>
                        ${ownerSettings}
                    </div>
                </div>
                `;
            })
            .catch(() => {
                content =  `
                <h2 class="text-center">OOPS! There was an error :(</h2>
                `;
            })
            .finally(() => {
                document.querySelector("#main-content").innerHTML = content;
            });

        document.querySelector("#main-content").innerHTML
        document.querySelector("#title").textContent = `Polariscope Settings > User Settings`;
    }

    function displayActivity(){
        document.querySelector("#title").textContent = `Polariscope Settings > User Settings > Activity`;
        const activityFetch = fetch('/api/account/activity/all')

        let content = "";
        Promise.all([activityFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                let tableContent = "";

                data[0].forEach((log) => {
                    console.log(log)
                    tableContent += `
                    <tr>
                        <th>${formatTimestamp(new Date(log.created))}</th>
                        <td>${log.activityType}</td>
                    </tr>
                    `;
                });

                content = `
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a onclick="displayUserSettings()" class="text-decoration-underline">< Back to User Settings</a>
                    </div>
                    <div class="col-md-9">
                        <table class="table table-responsive">
                          <thead>
                            <tr>
                              <th scope="col">Date</th>
                              <th scope="col">Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${tableContent}
                          </tbody>
                        </table>
                    </div>
                </div>
                `;
            })
            .catch(() => {
                content =  `
                <h2 class="text-center">OOPS! There was an error :(</h2>
                `;
            })
            .finally(() => {
                document.querySelector("#main-content").innerHTML = content;
            });
    }

    function displayNewUser(){
        document.querySelector("#main-content").innerHTML = `
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a onclick="displayUserSettings()" class="text-decoration-underline">< Back to User Settings</a>
                    </div>
                    <div class="col-md-9">
                        <h2 class="fw-bold">Create New User</h2>
                        <div class="row mt-2">
                            <div class="col-12 mb-3">
                                <label for="username-form">Username</label>
                                <input type="text" class="form-control" id="username-form" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="password">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <p id="status-text"></p>
                            <button type="submit" class="btn btn-primary" onclick="saveNewUser()" id="submit-button">Save</button>
                        </div>
                    </div>
                </div>
                `;
    }

    function saveNewUser(){
        const form = {
            username: document.querySelector("#username-form").value,
            password: document.querySelector("#password").value
        }

        let toastId = createToast("Saving User");
        postData("/api/account/new", form)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
                document.getElementById("#status-text").innerText = message.title + " " + message.body;
            })
            .catch((response) => {
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                        document.getElementById("#status-text").innerText = errorData.title + " " + errorData.body;
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            });
    }

    function displayGroups(){
        document.querySelector("#title").textContent = `Polariscope Settings > User Settings > Groups`;
        const activityFetch = fetch('/api/interpersonal/enums')

        let content = "";
        Promise.all([activityFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                enums = data[0];
                let tableContent = "";
                data[0].groups.forEach((group) => {
                    tableContent += `
                    <tr>
                        <td scope="row"><img class="square-image" style="height: 40px; width: 40px" alt="profile image" src="/api/interpersonal/group/image/${group.id}?=${new Date().getTime()}"></td>
                        <td style="vertical-align: middle" class="fw-bold">${group.name}</td>
                        <td style="vertical-align: middle"><div class="square-image" style="height: 30px; background-color: rgb(${group.color.red}, ${group.color.green}, ${group.color.blue})"></div></td>
                        <td style="vertical-align: middle">${group.description}</td>
                        <td style="vertical-align: middle">${formatTimestamp(new Date(group.lastModified))}</td>
                        <td style="vertical-align: middle">${group.numMembers}</td>
                        <td style="vertical-align: middle"><button class="btn btn-secondary" onclick="updateModal('${group.id}')" data-bs-toggle="modal" data-bs-target="#saveGroupModal">Edit</button></td>
                        <td style="vertical-align: middle"><button class="btn btn-danger bevel-sm" onclick="deleteGroup('${group.id}')">Delete</button></td>
                    </tr>
                    `;
                });

                content = `
                <div class="row">
                    <div class="col-md-3 col-lg-2 mb-2">
                        <a onclick="displayUserSettings()" class="text-decoration-underline">< Back to User Settings</a>
                    </div>
                    <div class="col-md-9 col-lg-10">
                        <div class="d-flex flex-row-reverse mb-2">
                            <button class="btn btn-secondary" onclick="resetGroupModal()" data-bs-toggle="modal" data-bs-target="#saveGroupModal">+ New Group</button>
                        </div>
                        <table class="table table-responsive">
                          <thead>
                            <tr>
                              <th scope="col">Icon</th>
                              <th scope="col">Name</th>
                              <th scope="col">Color</th>
                              <th scope="col">Description</th>
                              <th scope="col">Modified</th>
                              <th scope="col">Members</th>
                              <th scope="col">Edit</th>
                              <th scope="col">Delete</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${tableContent}
                          </tbody>
                        </table>
                    </div>
                </div>
                `;
            })
            .catch(() => {
                content =  `
                <h2 class="text-center">OOPS! There was an error :(</h2>
                `;
            })
            .finally(() => {
                document.querySelector("#main-content").innerHTML = content;
            });
    }

    function resetGroupModal(){
        document.querySelector("#group-description-form").value = "";
        document.querySelector("#group-id-form").value = "";
        document.querySelector("#group-title-form").value = "";
        document.querySelector("#saveGroupModalTitle").innerText = "New Group";
        document.querySelector("#group-red-form").value = Math.floor(Math.random() * 256);
        document.querySelector("#group-green-form").value = Math.floor(Math.random() * 256);
        document.querySelector("#group-blue-form").value = Math.floor(Math.random() * 256);
        updateColorPreview();
    }

    function updateModal(id){
        const group = enums.groups.find(g => g.id === id);
        document.querySelector("#group-description-form").value = group.description;
        document.querySelector("#group-id-form").value = id;
        document.querySelector("#group-title-form").value = group.name;
        document.querySelector("#group-red-form").value = group.color.red;
        document.querySelector("#group-green-form").value = group.color.green;
        document.querySelector("#group-blue-form").value = group.color.blue;
        document.querySelector("#saveGroupModalTitle").innerText = "Edit Group";
        updateColorPreview();
    }

    function updateColorPreview(){
        const color = "rgb(" + document.querySelector("#group-red-form").value + "," + document.querySelector("#group-green-form").value + "," + document.querySelector("#group-blue-form").value + ")";
        console.log(color);
        document.querySelector("#color-preview").style.backgroundColor = color;
    }

    function modalSaveGroup(){
        const formData = new FormData();

        const imageFile = document.getElementById('pfp-file').files[0];
        formData.append('image', imageFile);

        formData.append('id',           document.querySelector("#group-id-form").value);
        formData.append('description',  document.querySelector("#group-description-form").value);
        formData.append('name',         document.querySelector("#group-title-form").value);
        formData.append('red',          document.querySelector("#group-red-form").value);
        formData.append('green',        document.querySelector("#group-green-form").value);
        formData.append('blue',         document.querySelector("#group-blue-form").value);

        let toastId = createToast("Saving Group");
        postDataWithFile("/api/interpersonal/group/save", formData)
            .then((message) => {
                message.json()
                    .then(messageData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(messageData.severity) + messageData.message;
                        document.getElementById(`${toastId}-title`).innerText =  messageData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "green";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {displayGroups()});
    }

    function deleteGroup(id){
        let toastId = createToast("Deleting Group");
        postData("/api/interpersonal/group/delete", id)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {displayGroups()});
    }


    document.querySelector("#group-red-form").addEventListener('input', function() {
        updateColorPreview();
    });
    document.querySelector("#group-green-form").addEventListener('input', function() {
        updateColorPreview();
    });
    document.querySelector("#group-blue-form").addEventListener('input', function() {
        updateColorPreview();
    });
</script>
</body>
</html>