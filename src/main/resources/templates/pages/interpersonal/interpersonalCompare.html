<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Compare')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: navigation}"></div>
<main class="bg-2 text-1" data-bs-theme="dark">
    <div class="container-fluid bg-body">

        <nav class="navbar d-flex justify-content-between align-items-center">
            <div>
                <a href="/interpersonal">< Interpersonal Home</a>
            </div>
        </nav>

        <div class="row my-3">
            <div class="col-lg-3 d-none d-lg-block">
                <canvas id="composition-chart"></canvas>
            </div>
            <div class="col-12 col-lg-9 px-3">
                <h2 class="fw-bold mt-3">Member Compare</h2>
                <div>
                    <canvas id="evaluation-history-chart"></canvas>
                </div>
                <button type="button" class="btn btn-primary mt-3" onclick="saveEvaluation()" data-bs-toggle="modal" data-bs-target="#member-modal">Add Members</button>
                <button type="button" class="btn btn-primary mt-3" onclick="saveEvaluation(true)">Something else</button>
                <div id="timeline-table-container">

                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" tabindex="-1" aria-labelledby="be" id="member-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="be">Choose Members to Compare</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p>This tool allows you to compare and contrast saved member evaluation scores over time. You are able to add as many members as you choose. If you would like to include or remove a member from the graph, simply click on the member's name and press apply.</p>
                    </div>
                    <div class="col-12">
                        <div class="accordion" id="accordionPanelsStayOpenExample">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                        Included Members
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show">
                                    <div class="list-group" id="member-list-included">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                        Members Not Included
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-not-included">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTimestamp()" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Gradient :: gradient}"></div>
<div th:replace="~{components/Network :: network}"></div>
<script>

    let memberList;

    createEvalChart();
    refresh();

    function refresh(){
        const memberListFetch = fetch("/api/interpersonal/member/all", {});
        Promise.all([memberListFetch])
            .then(responses => {
                return Promise.all([responses[0]]);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                memberList = data[0];
                renderMemberModal();
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            });
    }

    function renderMemberModal(){
        const notIncludedContainer = document.querySelector("#member-list-not-included");
        const includedContainer = document.querySelector("#member-list-included");
        let notIncluded = "", included = "";
        memberList.forEach((member) => {
            let element = `<button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2" onclick="toggleMark('${member.id}')">
                                <div class="d-flex justify-content-start gap-2 align-items-center">
                                    <img class="square-image img-fluid" style="width: 20px; height: 20px;" alt="pfp" src="/api/interpersonal/member/profile-image/${member.id}" />
                                    <p class="mb-0 fw-bold ms-2">${member.firstName} ${member.lastName}</p>
                                </div>
                                <p class="mb-0 fw-bold" style="color: ${getColorGradient(member.lastEvaluation.cscore, -100, 100)}">${member.lastEvaluation.cscore}</p>
                            </button>`;

            if("included" in member && member.included === true){
                included += element;
            }else{
                notIncluded += element;
            }
        });
        notIncludedContainer.innerHTML = notIncluded;
        includedContainer.innerHTML = included;
    }

    function toggleMark(id){
        let member = memberList.find(m => m.id === id);
        if("included" in member && member.included === true){
            member.included = false;
        }else{
            member.included = true;
        }
        renderMemberModal();
    }

    function createEvalChart(){
        let canvas = document.querySelector("#evaluation-history-chart");
        let scores = {datasets: [{data:[]}]};
        evalChartEval = new Chart(canvas, {
            type: 'line',
            data:scores,
            options: {
                aspectRatio: 4,
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                        }
                    },
                },
            }
        });
    }
</script>
</body>
</html>