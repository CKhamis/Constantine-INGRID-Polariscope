<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Compare')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: navigation}"></div>
<main class="bg-2 text-1" data-bs-theme="dark">
    <div class="container-fluid bg-body">

        <nav class="navbar d-flex justify-content-between align-items-center">
            <div>
                <a href="/interpersonal">< Interpersonal Home</a>
            </div>
            <div>
                <div class="spinner-border d-none" role="status" id="loading-spinner">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <img src="/icons/Logo.svg" id="error-icon" alt="error" class="square-image d-none" height="32px" />
            </div>

        </nav>

        <div class="row my-3">
            <div class="col-lg-3 d-none d-lg-block">
                <canvas id="composition-chart"></canvas>
            </div>
            <div class="col-12 col-lg-9 px-3">
                <h2 class="fw-bold mt-3">Member Compare</h2>
                <div>
                    <canvas id="evaluation-history-chart"></canvas>
                </div>
                <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#member-modal">Add Members</button>
                <button type="button" class="btn btn-primary mt-3" onclick="saveEvaluation(true)">Something else</button>
                <div id="timeline-table-container">

                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" tabindex="-1" aria-labelledby="be" id="member-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="be">Choose Members to Compare</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p>This tool allows you to compare and contrast saved member evaluation scores over time. You are able to add as many members as you choose. If you would like to include or remove a member from the graph, simply click on the member's name and press apply.</p>
                    </div>
                    <div class="col-12">
                        <div class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                                        Included Members
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-included">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                        Members Not Included
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                    <div class="list-group" id="member-list-not-included">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="retrieveMemberDetails()" data-bs-dismiss="modal">Apply</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Gradient :: gradient}"></div>
<div th:replace="~{components/Network :: network}"></div>
<script>
    let memberList;
    let memberDetailList;

    let evalChart;

    createEvalChart();
    refresh();

    async function retrieveMemberDetails() {
        let spinner = document.querySelector("#loading-spinner");
        let error = document.querySelector("#error-icon");
        spinner.classList.add("d-block");
        spinner.classList.remove("d-none");

        const fetchArray = memberList
            .filter(member => member.included === true)
            .map(member => fetch("/api/interpersonal/member/view/" + member.id, {}));

        memberDetailList = [];

        Promise.all(fetchArray)
            .then(responses => {
                // Check if all responses are ok
                responses.forEach(response => {
                    if (!response.ok) {
                        error.classList.add("d-block");
                        error.classList.remove("d-none");
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                });
                // Convert all responses to JSON
                return Promise.all(responses.map(response => response.json()));
            })
            .then(dataArray => {
                // Handle the array of data objects
                dataArray.forEach(data => {
                    memberDetailList.push(data);
                    console.log(data);
                });
            })
            .catch(error => {
                error.classList.add("d-block");
                error.classList.remove("d-none");
                console.error("Error:", error);
                if (error.response) {
                    error.response.json()
                        .then(errorData => {
                            console.log(errorData.message);
                        })
                        .catch(parseError => {
                            console.error("Error parsing error response:", parseError);
                        });
                }
            })
            .finally(() => {
                spinner.classList.remove("d-block");
                spinner.classList.add("d-none");

                updateChart();
            });

    }

    function updateChart(){
        let datasets = [];
        for(const member of memberDetailList){
            let chartEntryData = [];
            member.fullTimeline.forEach((eval) => {
                chartEntryData.push({x: new Date(eval.timestamp), y: eval.cscore})
            })

            const chartEntry = {
                label: member.firstName + ' ' + member.lastName,
                data: chartEntryData,
                borderColor: getColorGradient(member.mostRecentEval.cscore, -100, 100)
            }

            datasets.push(chartEntry);
        }

        evalChart.data.datasets = datasets;
        evalChart.update();
    }
    function refresh(){
        const memberListFetch = fetch("/api/interpersonal/member/all", {});
        Promise.all([memberListFetch])
            .then(responses => {
                return Promise.all([responses[0]]);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                memberList = data[0];
                renderMemberModal();
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            });
    }

    function renderMemberModal(){
        const notIncludedContainer = document.querySelector("#member-list-not-included");
        const includedContainer = document.querySelector("#member-list-included");
        let notIncluded = "", included = "";
        memberList.forEach((member) => {
            let element = `<button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2" onclick="toggleMark('${member.id}')">
                                <div class="d-flex justify-content-start gap-2 align-items-center">
                                    <img class="square-image img-fluid" style="width: 20px; height: 20px;" alt="pfp" src="/api/interpersonal/member/profile-image/${member.id}" />
                                    <p class="mb-0 fw-bold ms-2">${member.firstName} ${member.lastName}</p>
                                </div>
                                <p class="mb-0 fw-bold" style="color: ${getColorGradient(member.lastEvaluation.cscore, -100, 100)}">${member.lastEvaluation.cscore}</p>
                            </button>`;

            if("included" in member && member.included === true){
                included += element;
            }else{
                notIncluded += element;
            }
        });
        notIncludedContainer.innerHTML = notIncluded;
        includedContainer.innerHTML = included;
    }

    function toggleMark(id){
        let member = memberList.find(m => m.id === id);
        member.included = !("included" in member && member.included === true);
        renderMemberModal();
    }

    function createEvalChart(){
        let canvas = document.querySelector("#evaluation-history-chart");
        let scores = {datasets: [{data:[]}]};
        evalChart = new Chart(canvas, {
            type: 'line',
            data:scores,
            options: {
                aspectRatio: 3,
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                        }
                    },
                },
            }
        });
    }
</script>
</body>
</html>