<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Home')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: navigation}"></div>
<main class="pt-3">
<div class="container-fluid px-4">

    <nav class="navbar d-flex justify-content-between align-items-center">
        <div>
            <a href="/interpersonal">< Interpersonal Home</a>
        </div>
        <div>
            <div class="input-group">
                <select class="form-select" id="member-select">
                </select>
                <button class="btn btn-primary" type="button" onclick="changeUser()">Change</button>
            </div>
        </div>
    </nav>

    <div class="row mt-3">
        <div class="col-md-3 col-lg-2 mb-4" id="left-pane">
            <img class="square-image" th:src="@{/icons/Logo.svg}" alt="profile image" />
            <h2 class="fw-bold text-center mt-3" id="member-name">Test Name</h2>
            <div class="d-flex justify-content-between align-items-center mt-5">
                <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="relation-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Relationship"/>
                <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="sex-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Sex"/>
                <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="orientation-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Sexuality"/>
            </div>
            <div class="mt-4 bg-light-subtle d-flex justify-content-center align-items-center py-4" role="button" data-bs-toggle="modal" data-bs-target="#addEvalModal" onclick="updateModalTime()">
                <p class="fs-4 fs-bold text-center m-0">+ Add Evaluation</p>
            </div>
        </div>
        <div class="col-md-9 col-lg-10 px-3" id="right-pane">
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-overview-tab" data-bs-toggle="tab" data-bs-target="#nav-overview" type="button" role="tab" aria-controls="nav-overview" aria-selected="true">Overview</button>
                    <button class="nav-link" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button" role="tab" aria-controls="nav-info" aria-selected="false">Information</button>
                    <button class="nav-link" id="nav-evaluation-tab" data-bs-toggle="tab" data-bs-target="#nav-evaluation" type="button" role="tab" aria-controls="nav-evaluation" aria-selected="false">Evaluations</button>
                    <button class="nav-link" id="nav-settings-tab" data-bs-toggle="tab" data-bs-target="#nav-settings" type="button" role="tab" aria-controls="nav-settings" aria-selected="false">Settings</button>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-overview" role="tabpanel" aria-labelledby="nav-overview-tab" tabindex="0">Home</div>
                <div class="tab-pane fade" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab" tabindex="0">

                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="fw-bold mt-3">Member Information</h2>
                        <div class="bg-light-subtle d-flex justify-content-between align-items-center p-2" role="button">
                            <p class="mb-0 mx-2 fs-5 fw-bold">Edit</p>
                            <img class="square-image" th:src="@{/icons/Edit.svg}" alt="edit" style="width: 30px;"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 col-lg-4 col-xl-3 px-2 mb-2">
                            <div class="p-4 bg-secondary-subtle h-100" id="info-relationship">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-8 col-xl-6 px-2 mb-2">
                            <div class="p-4 bg-secondary-subtle h-100" id="info-description">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4 col-xl-3 px-2 mb-2">
                            <div class="p-4 bg-secondary-subtle h-100" id="info-general">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="nav-evaluation" role="tabpanel" aria-labelledby="nav-evaluation-tab" tabindex="0">
                    <h2 class="fw-bold mt-3">Evaluation Records</h2>
                    <div>
                        <canvas id="evaluation-history-chart"></canvas>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="fw-bold mt-3">All Evaluations</h2>
                        <div class="bg-light-subtle d-flex justify-content-between align-items-center p-2" role="button">
                            <p class="mb-0 mx-2 fs-5 fw-bold">Filter</p>
                            <img class="square-image" th:src="@{/icons/Filter.svg}" alt="edit" style="width: 30px;"/>
                        </div>
                    </div>
                    <div id="eval-table-container"></div>
                </div>
                <div class="tab-pane fade" id="nav-settings" role="tabpanel" aria-labelledby="nav-settings-tab" tabindex="0">Settings</div>
            </div>
        </div>
    </div>
</div>
</main>

<div class="modal fade" id="addEvalModal" tabindex="-1" aria-labelledby="aemt" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="aemt">Add Evaluation</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h4 class="fw-bold text-center" id="recent-score-modal"></h4>
                    </div>
                    <div class="col-9">
                        <label for="date-form-modal" class="form-label">Date</label>
                        <input type="datetime-local" class="form-control" id="date-form-modal">
                    </div>
                    <div class="col-3 mb-3">
                        <label for="cScore-form-modal" class="form-label">cScore</label>
                        <input type="number" class="form-control" id="cScore-form-modal" required>
                    </div>
                    <div class="col-12">
                        <label for="note-form-modal" class="form-label">Note</label>
                        <textarea class="form-control" id="note-form-modal" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="modalSaveEval()" data-bs-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>


<input type="hidden" th:value="${id}" id="id-form" />
<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Network :: network}"></div>
<div th:replace="~{components/External :: tooltips}"></div>
<div th:replace="~{components/Formatting :: date-formatting}"></div>
<div th:replace="~{components/Toast :: toast}"></div>
<script>
    let memberList;
    let memberDetails;

    refresh();

    function refresh(){
        let memberId = document.querySelector("#id-form").value;
        const memberListFetch = fetch("/api/interpersonal/member/all", {});
        const memberDetailFetch = fetch("/api/interpersonal/member/view/" + memberId, {});
        Promise.all([memberListFetch, memberDetailFetch])
            .then(responses => {
                return Promise.all([responses[0], responses[1]]);
            })
            .then(data => {
                return Promise.all([data[0].json(), data[1].json()]);
            })
            .then(data => {
                memberList = data[0];
                memberDetails = data[1];
                renderMemberSelect(data[0]);
                renderBadges();
                document.querySelector("#member-name").textContent = memberDetails.firstName + " " + memberDetails.lastName;
                if(memberDetails.mostRecentScore != null){
                    document.querySelector("#recent-score-modal").textContent = "Most recent cScore" + memberDetails.mostRecentScore;
                }
                renderInfoTab();
                renderEvaluationTable();
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            })
    }

    function modalSaveEval(){
        let data = {
            "id": null,
            "timestamp": document.querySelector("#date-form-modal").value,
            "cscore": document.querySelector("#cScore-form-modal").value,
            "note": document.querySelector("#note-form-modal").value,
            "memberId": document.querySelector("#id-form").value
        };

        let toastId = createToast("Insert Evaluation");
        postData("/api/interpersonal/evaluation/save", data)
            .then(() => {
                document.getElementById(`${toastId}-body`).innerText = "✅ New Evaluation Added";
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .then(refresh);
    }

    function renderInfoTab(){
        document.querySelector("#info-relationship").innerHTML = `
        <h3 class="fw-bold text-center">Relationship</h3>
        <p>Type: ${memberDetails.relationship}</p>
        <p>Year met: ${memberDetails.ageMet}</p>
        <p>Place met: ${memberDetails.placeMet}</p>
        `;

        document.querySelector("#info-description").innerHTML = `
        <h3 class="fw-bold">Description</h3>
        <p>${memberDetails.description}</p>
        `;

        document.querySelector("#info-general").innerHTML = `
        <h3 class="fw-bold text-center">General</h3>
        <p>Birthday: ${formatDate(memberDetails.birthday)}</p>
        <p>Favorite color: ${memberDetails.favoriteColor}</p>
        <p>Sexuality: ${memberDetails.sexuality}</p>
        <p>Personality: ${memberDetails.personality}</p>
        `;
    }

    function renderMemberSelect(members){
        let HTMLContent = ``;
        members.forEach((member) => {
            HTMLContent += `
                <option value="${member.id}">${member.firstName} ${member.lastName}</option>
            `;
        });
        document.querySelector("#member-select").innerHTML = HTMLContent;
    }

    function renderBadges(){
        let relationshipIcon = document.querySelector("#relation-icon");
        if(memberDetails.relationship.length > 0){
            relationshipIcon.src = "/icons/relations/" + memberDetails.relationship + ".svg";
        }else{
            relationshipIcon.src = "/icons/Unknown.svg";
        }

        let sexIcon = document.querySelector("#sex-icon");
        if(memberDetails.sex.length > 0){
            sexIcon.src = "/icons/sex/" + memberDetails.sex + ".svg";
        }else{
            sexIcon.src = "/icons/Unknown.svg";
        }

        let sexualityIcon = document.querySelector("#orientation-icon");
        if(memberDetails.sex.length > 0){
            sexualityIcon.src = "/icons/sexuality/" + memberDetails.sexuality + ".svg";
        }else{
            sexualityIcon.src = "/icons/Unknown.svg";
        }
    }

    function renderEvaluationTable(before = null, after = null, noteHas = null, addon = ""){
        let tableHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Timestamp</th>
                    <th scope="col">cScore</th>
                    <th scope="col">Note</th>
                    <th scope="col">Edit</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
            ${addon}
        `; // todo: use the addon to implement inline forms to add in more cScore values at once

        memberDetails.shortTimeline.forEach((eval) => {
            console.log(eval);
            tableHTML += `
                <tr id="${eval.id}">
                    <th>${formatDate(eval.timestamp)}</th>
                    <th>${eval.cscore}</th>
                    <th>${eval.note}</th>
                    <th>button</th>
                    <th><button class="btn btn-danger">Delete</button></th>
                </tr>
            `;
        });

        tableHTML +="</tbody></table>";
        document.querySelector("#eval-table-container").innerHTML = tableHTML;
    }

    function changeUser(){
        document.querySelector("#id-form").value = document.querySelector("#member-select").value;
        refresh();
    }

    function updateModalTime(){
        const dateInput = document.getElementById('date-form-modal');

        const currentDate = new Date();
        const localDate = new Date(currentDate.getTime() - currentDate.getTimezoneOffset() * 60000);
        const formattedDate = localDate.toISOString().slice(0, 16); // Format as "YYYY-MM-DDTHH:MM"
        dateInput.value = formattedDate;

    }
</script>
</body>
</html>