<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('View Member')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: vertical}"></div>

<main class="bg-2" style="margin-left: 60px; height: 100vh;">
    <div class="w-100 h-100 row m-0">
        <div class="d-none d-lg-block col-2 h-100 border-end p-0">
            <div class="h-100 w-100 d-flex flex-column p-0">
                <div class="border-bottom flex-shrink-0 p-2">
                    <a href="/interpersonal/members">
                        <button class="btn btn-dark" role="button">< All Members</button>
                    </a>
                </div>
                <div class="border-bottom flex-grow-1 p-2">
                    <img class="square-image" th:src="@{/icons/Logo.svg}" alt="profile image" id="profile-image" />
                    <h2 class="fw-bold text-center mt-3" id="member-name">Test Name</h2>
                    <div class="d-flex justify-content-between align-items-center mt-5">
                        <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="relation-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Relationship"/>
                        <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="sex-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Sex"/>
                        <img class="square-image mx-2" th:src="@{/icons/Logo.svg}" id="orientation-icon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Sexuality"/>
                    </div>
                    <div class="mt-4 bg-light-subtle d-flex justify-content-center align-items-center py-4 bevel-lg" role="button" data-bs-toggle="modal" data-bs-target="#addEvalModal" onclick="updateModal()">
                        <p class="fs-4 fs-bold text-center m-0">+ Add Evaluation</p>
                    </div>
                </div>
                <div class="flex-shrink-0 p-2">
                    <div>
                        <div class="spinner-border d-none" role="status" id="loading-spinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <img src="/icons/Error.svg" id="error-icon" alt="error" class="square-image d-none" height="32px" />
                    </div>
                    <div>
                        <div class="input-group">
                            <select class="form-select" id="member-select"></select>
                            <button class="btn btn-primary bevel-sm" type="button" onclick="changeUser()">Change</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-10 p-0 h-100 overflow-y-scroll">
            <div class="m-0 pt-0 px-0" style="overflow: scroll">
                <div class="w-100 border-bottom px-3">
                    <nav>
                        <div class="nav nav-underline gap-4" id="nav-tab" role="tablist" style="flex-wrap: nowrap">
                            <button class="nav-link active fs-4" id="nav-overview-tab" data-bs-toggle="tab" data-bs-target="#nav-overview" type="button" role="tab" aria-controls="nav-overview" aria-selected="true">Overview</button>
                            <button class="nav-link fs-4" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button" role="tab" aria-controls="nav-info" aria-selected="false">Information</button>
                            <button class="nav-link fs-4" id="nav-events-tab" data-bs-toggle="tab" data-bs-target="#nav-events" type="button" role="tab" aria-controls="nav-events" aria-selected="false">Events</button>
                            <button class="nav-link fs-4" id="nav-evaluation-tab" data-bs-toggle="tab" data-bs-target="#nav-evaluation" type="button" role="tab" aria-controls="nav-evaluation" aria-selected="false">Evaluations</button>
                            <button class="nav-link fs-4" id="nav-network-tab" data-bs-toggle="tab" data-bs-target="#nav-network" type="button" role="tab" aria-controls="nav-network" aria-selected="false">Relationships</button>
                            <button class="nav-link fs-4" id="nav-settings-tab" data-bs-toggle="tab" data-bs-target="#nav-settings" type="button" role="tab" aria-controls="nav-settings" aria-selected="false">Settings</button>
                        </div>
                    </nav>
                </div>
            </div>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active p-2" id="nav-overview" role="tabpanel" aria-labelledby="nav-overview-tab" tabindex="0">
                    <div class="w-100 border mb-2 d-flex flex-row justify-content-between align-items-center" style="background-image: linear-gradient(to right, rgba(9, 188, 138, .5) 0%, rgba(9, 188, 138, 0))">
                        <p class="fs-1 fw-bold p-3 m-0 flex-grow-1" id="overview-name">Member Name</p>
                        <div class="p-3 flex-shrink-1">
                            <img class="square-image" style="width: 60px" alt="Member Group" th:src="@{/icons/Logo.svg}" id="overview-group" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Group"/>
                        </div>
                    </div>
                    <p id="overview-description" class="fs-5 mx-3">Member Description</p>
                    <div class="row mt-4 mb-3 w-100 mx-0" id="member-chips"></div>
                    <h2 class="fw-bold border-bottom mb-2">Evaluation Scores</h2>
                    <div class="position-relative">
                        <div class="position-absolute p-2" style="top: 0; right: 0;">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center p-2" role="button" onclick="evalChartEvalHome.resetZoom()">
                                <img class="square-image" src="/icons/Reset Zoom.svg" alt="Refresh" style="width: 20px;">
                            </div>
                        </div>
                        <canvas id="evaluation-history-chart-home"></canvas>
                    </div>
                    <div id="event-info-1" class="alert alert-secondary mt-2">Hover over event to see additional info</div>
                    <h3 class="fw-bold border-bottom mb-2 mt-4">Note History</h3>
                    <div id="note-list-home"></div>
                </div>
                <div class="tab-pane fade p-2 contain" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab" tabindex="0">
                    <h3 class="fw-bold border-bottom mb-3">Member Information</h3>
                    <div class="row mt-2 w-100 px-0">
                        <div class="col-12 mb-3 pe-0">
                            <label for="pfp-file" class="form-label">Upload profile image for member</label>
                            <input class="form-control" type="file" name="file" accept="image/*" id="pfp-file">
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="fnf">First name</label>
                            <input type="text" class="form-control" id="fnf" name="firstName" placeholder="First name" required>
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="lnf">Last name</label>
                            <input type="text" class="form-control" id="lnf" name="lastName" placeholder="Last name">
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="mnf">Middle name</label>
                            <input type="text" class="form-control" id="mnf" name="middleName" placeholder="Middle name">
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="relationf">Relationship Type</label>
                            <select class="form-select" id="relationf" name="relationship" required>
                                <option value="" disabled="disabled">Select Relationship Type</option>
                                <th:block th:each="relationshipType : ${relationshipTypes}">
                                    <option th:value="${relationshipType}" th:text="${relationshipType.toString().toLowerCase()}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="sexf">Sex</label>
                            <select class="form-select" id="sexf" name="relationship">
                                <option value="">Decline to state</option>
                                <th:block th:each="SexType : ${sexTypes}">
                                    <option th:value="${SexType}" th:text="${SexType.toString().toLowerCase()}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="sexualityf">Sexuality</label>
                            <select class="form-select" id="sexualityf" name="sexuality">
                                <option value="">Decline to state</option>
                                <th:block th:each="sexualityType : ${sexualityTypes}">
                                    <option th:value="${sexualityType}" th:text="${sexualityType.toString().toLowerCase()}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="mbp">MB Personality</label>
                            <input type="text" class="form-control" id="mbp" name="personality" placeholder="ENFJ">
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="fcf">Favorite Color</label>
                            <input type="text" class="form-control" id="fcf" name="favoriteColor" placeholder="Red">
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="amf">Year Met</label>
                            <input type="number" class="form-control" id="amf" name="ageMet" placeholder="2001" required>
                        </div>
                        <div class="col-md-4 mb-3 pe-0">
                            <label for="bdf">Birthday</label>
                            <input type="date" class="form-control" id="bdf" name="birthday">
                        </div>

                        <div class="col-md-4 mb-3 pe-0">
                            <label for="group-form">Primary Group</label>
                            <select class="form-select" id="group-form">
                                <option value="" selected>None</option>
                            </select>
                        </div>

                        <div class="col-12 mb-3 pe-0">
                            <label for="df">Description</label>
                            <textarea type="text" class="form-control" id="df" name="description" placeholder="Description of member" style="height: 100px"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="saveMember()" id="submit-button">Submit</button>
                </div>
                <div class="tab-pane fade" id="nav-evaluation" role="tabpanel" aria-labelledby="nav-evaluation-tab" tabindex="0">
                    <h3 class="fw-bold border-bottom mb-4 p-2">Evaluation Records</h3>
                    <div class="px-2 position-relative">
                        <div class="position-absolute p-2" style="top: 0; right: 0;">
                            <div class="bg-light-subtle d-flex justify-content-center align-items-center p-2" role="button" onclick="evalChartEval.resetZoom()">
                                <img class="square-image" src="/icons/Reset Zoom.svg" alt="Reset" style="width: 20px;">
                            </div>
                        </div>
                        <canvas id="evaluation-history-chart"></canvas>
                    </div>
                    <div>
                        <div id="event-info-2" class="alert alert-secondary mt-2">Hover over event to see additional info</div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                        <h3 class="fw-bold">All Evaluations</h3>
                        <div class="bg-light-subtle d-flex justify-content-between align-items-center p-2" role="button" data-bs-toggle="modal" data-bs-target="#filterModal">
                            <p class="mb-0 mx-2 fs-5 fw-bold">Filter</p>
                            <img class="square-image" th:src="@{/icons/Filter.svg}" alt="edit" style="width: 30px;"/>
                        </div>
                    </div>
                    <div id="eval-table-container"></div>
                </div>
                <div class="tab-pane fade p-2" id="nav-events" role="tabpanel" aria-labelledby="nav-events-tab" tabindex="0">
                    <div class="d-flex flex-row justify-content-between align-items-center mb-3 mt-2">
                        <h3 class="fw-bold">All Events</h3>
                        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#event-modal">Add/ Remove Events</button>
                    </div>
                    <div id="events-container"></div>
                </div>
                <div class="tab-pane fade" id="nav-network" role="tabpanel" aria-labelledby="nav-network-tab" tabindex="0">
                    <h3 class="fw-bold border-bottom p-2 mb-4">Member Relationships</h3>
                    <div class="" id="graph-container" style="height: calc(100vh - 13rem)"></div>
                    <div class="position-absolute bottom-0 end-0 bg-body-tertiary p-2 m-3 d-flex flex-row gap-2">
                        <button type="button" class="btn bg-light-subtle d-flex justify-content-center align-items-center p-2" data-bs-toggle="tooltip" data-bs-title="Reset View" onclick="cy.reset()">
                            <img class="square-image" src="/icons/Reset%20Zoom.svg" alt="refresh" style="width: 20px;">
                        </button>
                        <button type="button" class="btn bg-light-subtle d-flex justify-content-center align-items-center p-2" data-bs-toggle="modal" data-bs-target="#graph-modal">
                            <img class="square-image" src="/icons/Settings.svg" alt="refresh" style="width: 20px;">
                        </button>
                    </div>
                </div>
                <div class="tab-pane fade" id="nav-settings" role="tabpanel" aria-labelledby="nav-settings-tab" tabindex="0">
                    <h3 class="fw-bold border-bottom mb-3 p-2">Member Settings</h3>
                    <div class="px-2">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">Add or Remove Events</h5>
                                <p class="card-text">This will add or remove markers on the member's evaluation graphs. Use this to highlight important events.</p>
                                <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#event-modal">Add/ Remove Events</button>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">Score Hold</h5>
                                <p class="card-text">This will remove the member's appearance in the Batch Evaluate feature. Use this option if you do not anticipate not updating evaluations as frequently.</p>
                                <input type="checkbox" class="btn-check" id="score-hold-check" autocomplete="off">
                                <label class="btn btn-primary" for="score-hold-check" onclick="scoreHold()" id="hold-label">Score Hold</label>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">Archive Member</h5>
                                <p class="card-text">Removes appearances of member from all menus except for the all members feature. Does not delete the member.</p>
                                <input type="checkbox" class="btn-check" id="archive-member-check" autocomplete="off">
                                <label class="btn btn-primary" for="archive-member-check" onclick="archive()" id="archive-label">Archive Member</label>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">Delete Member</h5>
                                <p class="card-text">Deletes a member from database permanently. This procedure deletes the member as well as associated data such as evaluations. Not recommended for almost any scenario</p>
                                <button class="btn btn-danger bevel-sm" data-bs-toggle="modal" data-bs-target="#deleteMemberModal">Delete Member</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="addEvalModal" tabindex="-1" aria-labelledby="aemt" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="aemt">Save Evaluation</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h4 class="fw-bold text-center" id="recent-score-modal"></h4>
                    </div>
                    <div class="col-9">
                        <label for="date-form-modal" class="form-label">Date</label>
                        <input type="datetime-local" class="form-control" id="date-form-modal">
                    </div>
                    <div class="col-3 mb-3">
                        <label for="cScore-form-modal" class="form-label">cScore</label>
                        <input type="number" class="form-control" id="cScore-form-modal" required>
                    </div>
                    <div class="col-12">
                        <label for="note-form-modal" class="form-label">Note</label>
                        <textarea class="form-control" id="note-form-modal" style="height:100px"></textarea>
                    </div>
                    <input type="hidden" id="id-evaluation-modal" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="modalSaveEval()" data-bs-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteMemberModal" tabindex="-1" aria-labelledby="dmm" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="dmm">Delete Member & Evaluations?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>This action cannot be undone unless a backup was made and restored. This will delete all evaluations and member details permanently. It is highly recommended to archive and hold rather than delete members. If you have read this warning and would still like to delete the member, use the button below.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="deleteMember()" data-bs-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="fmt" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="fmt">Filter Settings</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <label for="before-form" class="form-label">Show Evaluations Before</label>
                        <div class="input-group mb-3" id="before-form">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox" value="" id="before-checkbox-filter-modal" aria-label="Enable filtering before a date">
                            </div>
                            <input type="datetime-local" class="form-control" aria-label="before input" id="before-form-filter-modal">
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="after-form" class="form-label">Show Evaluations After</label>
                        <div class="input-group mb-3" id="after-form">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox" value="" id="after-checkbox-filter-modal" aria-label="Enable filtering after a date">
                            </div>
                            <input type="datetime-local" class="form-control" aria-label="after input" id="after-form-filter-modal">
                        </div>
                    </div>
                    <div class="col-12">
                        <label for="keyword-filter-modal" class="form-label">Note contains</label>
                        <textarea class="form-control" id="keyword-filter-modal" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="renderEvaluationTable()" data-bs-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" aria-labelledby="be" id="event-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="be">Events</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <p>Please choose events you would like to be depicted inside evaluation graphs. To add more events, please go to settings</p>
                    </div>
                    <div class="col-12">
                        <div class="accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                                        Included Events
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
                                    <div class="list-group" id="event-list-included">
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                        Events Not Included
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                    <div class="list-group" id="event-list-not-included">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="saveEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="saveEventModalTitle">Save Event</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="event-label-form" class="form-label">Label</label>
                        <input type="text" class="form-control" id="event-label-form" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="event-date-form" class="form-label">Date</label>
                        <input type="datetime-local" class="form-control" id="event-date-form">
                    </div>
                    <div class="col-12">
                        <label for="event-description-form" class="form-label">Description</label>
                        <textarea class="form-control" id="event-description-form" style="height:100px"></textarea>
                    </div>
                    <div class="col-12 mt-3">
                        <label for="event-color-preview" class="form-label">Color</label>
                        <div class="container" style="height:40px" id="event-color-preview"></div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="event-red-form">Red</label>
                            <input type="number" class="form-control" id="event-red-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="event-green-form">Green</label>
                            <input type="number" class="form-control" id="event-green-form">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <label class="input-group-text" for="event-blue-form">Blue</label>
                            <input type="number" class="form-control" id="event-blue-form">
                        </div>
                    </div>
                    <input type="hidden" id="event-id-form" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="modalSaveEvent()" data-bs-dismiss="modal">Save Event</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="relationship-modal" tabindex="-1" aria-labelledby="relationship-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="relationship-modal-label">Create / Edit Relationship</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to edit the one-way relationship between two Polariscope members. Please review carefully and proceed</p>
                <div class="d-flex flex-row gap-3 align-items-center justify-content-center py-3 my-2" style="background: linear-gradient(#222, #333); border-bottom: 1px #495057 solid; border-top: 1px #495057 solid;">
                    <div class="d-flex flex-column align-items-center">
                        <img id="modal-person-1-img" class="profile-image" alt="person 1" src="/icons/Default%20User.svg" width="100px" />
                        <p id="modal-person-1-name" class="mb-0 fw-bold">Person 1</p>
                    </div>
                    <img src="/icons/Arrow.svg" class="mx-3" style="transform: rotate(-90deg)" width="70px" alt="Arrow pointing right" />
                    <div class="d-flex flex-column align-items-center">
                        <img id="modal-person-2-img" class="profile-image" alt="person 2" src="/icons/Default%20User.svg" width="100px" />
                        <p id="modal-person-2-name" class="mb-0 fw-bold">Person 2</p>
                    </div>
                </div>
                <div class="d-flex flex-row justify-content-between">
                    <p id="modal-relationship-health"></p>
                    <p id="modal-relationship-type"></p>
                </div>
                <div class="mt-2">
                    <p class="fs-4 fw-bold">Relationship Details</p>
                    <div class="mb-3">
                        <label for="modal-relationship-type-form">Relationship Type</label>
                        <select class="form-select" id="modal-relationship-type-form" name="relationship" required>
                            <option value="" disabled>Select Relationship Type</option>
                            <th:block th:each="relationshipType : ${relationshipTypes}">
                                <option th:value="${relationshipType}" th:text="${relationshipType.toString().toLowerCase()}"></option>
                            </th:block>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="modal-relationship-health-form" class="form-label">Relationship Health</label>
                        <input type="number" class="form-control" id="modal-relationship-health-form" required>
                    </div>

                    <div class="mb-3">
                        <label for="modal-relationship-description" class="form-label">Description</label>
                        <textarea class="form-control" id="modal-relationship-description" style="height:100px"></textarea>
                    </div>

                    <input type="hidden" id="modal-self" />
                    <input type="hidden" id="modal-other" />

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" data-bs-dismiss="modal" onclick="saveRelationship()">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="graph-modal" tabindex="-1" aria-labelledby="graph-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="graph-modal-label">Graph Settings</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column gap-2">
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Show Profile Images</h4>
                    <p>Shows profile images on top of each node representing a member if applicable.</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="graph-checkbox-img">
                        <label class="form-check-label" for="graph-checkbox-img">
                            Show profile images
                        </label>
                    </div>
                </div>
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Show Names</h4>
                    <p>Display member names as labels on each node.</p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="graph-checkbox-labels" checked>
                        <label class="form-check-label" for="graph-checkbox-labels">
                            Show names
                        </label>
                    </div>
                </div>
                <div class="bg-body-tertiary p-3">
                    <h4 class="fw-bold">Relationship Strength</h4>
                    <p>Displays edges that have an absolute value of above the given amount.</p>
                    <div class="d-flex flex-row justify-content-start align-items-center">
                        <p id="tolerance-indicator" style="width: 40px" class="text-center">0</p>
                        <div class="form-check p-0 flex-grow-1">
                            <label for="graph-range-show" class="form-label">Tolerance level</label>
                            <input type="range" class="form-range" min="0" max="100" id="graph-range-show" onchange="updateToleranceIndicator()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="renderNetwork()" data-bs-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" th:value="${id}" id="id-form" />
<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Network :: data-upload}"></div>
<div th:replace="~{components/Network :: network}"></div>
<div th:replace="~{components/External :: tooltips}"></div>
<div th:replace="~{components/Formatting :: timestamp-formatting}"></div>
<div th:replace="~{components/Formatting :: date-formatting}"></div>
<div th:replace="~{components/Formatting :: time-interval}"></div>
<div th:replace="~{components/Gradient :: gradient}"></div>
<div th:replace="~{components/Toast :: toast}"></div>
<script src="/external/cytoscape.min.js"></script>

<script>
    let memberList;
    let memberDetails;
    let eventList;
    let enums;
    let evalChartEval, evalChartEvalHome;
    let memberRelationships;

    let cy = cytoscape({

        container: document.getElementById('graph-container'),

        style: [ // the stylesheet for the graph
            {
                selector: 'node',
                style: {
                    'background-color': 'data(color)',
                    'label': 'data(name)',
                    'color': 'white',
                    'text-wrap': 'ellipsis',
                    'background-opacity': 'data(opacity)',
                    'shape': 'data(shape)',
                    'background-image': 'data(img)',
                    'background-image-opacity': 'data(imgOpacity)',
                    'background-fit': 'contain'
                }
            },

            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': 'data(color)',
                    'target-arrow-color': 'data(color)',
                    'target-arrow-shape': 'chevron',
                    'curve-style': 'bezier',
                    'opacity': 'data(opacity)'
                }
            }
        ],
    });

    refresh();
    createEvalChart();

    function refresh(){
        let memberId = document.querySelector("#id-form").value;
        let spinner = document.querySelector("#loading-spinner");
        spinner.classList.add("d-block");
        spinner.classList.remove("d-none");
        let errorIcon = document.querySelector("#error-icon");

        const memberListFetch = fetch("/api/interpersonal/member/all", {});
        const enumFetch = fetch("/api/interpersonal/enums", {});
        const memberDetailFetch = fetch("/api/interpersonal/member/view/" + memberId, {});
        const allEventFetch = fetch("/api/interpersonal/event/all", {});
        const relFetch = fetch("/api/interpersonal/relationship/all", {});
        Promise.all([memberListFetch, memberDetailFetch, enumFetch, allEventFetch, relFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json(), data[1].json(), data[2].json(), data[3].json(), data[4].json()]);
            })
            .then(data => {
                memberRelationships = data[4];
                tableAddons = "";
                memberList = data[0];
                memberDetails = data[1];
                enums = data[2];
                eventList = data[3];
                renderMemberSelect(data[0]);
                renderBadges();
                document.querySelector("#member-name").textContent = memberDetails.firstName + " " + memberDetails.lastName;
                if(memberDetails.mostRecentEval != null){
                    document.querySelector("#recent-score-modal").textContent = "Most recent cScore: " + memberDetails.mostRecentEval.cscore;
                }
                renderOverviewTab();
                renderInfoTab();
                updateEvalChart();
                renderEvaluationTable();
                updateEventModal();
                updateGroups();
                updateEventsTab();
                renderNetwork();
            })
            .then((response) => {
                if(memberDetails.group !== null){
                    document.querySelector("#group-form").value = memberDetails.group.id;
                }
                return response;
            })
            .catch((response) => {
                console.log(response);
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");

                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            })
            .finally(() => {
                document.querySelector("#profile-image").src = "/api/interpersonal/member/profile-image/" + memberDetails.id + "?=" + new Date().getTime();
                spinner.classList.remove("d-block");
                spinner.classList.add("d-none");
            });
    }

    function updateEventsTab(){
        let content = "";

        memberDetails.events.forEach((event) => {
            content += `
            <div class="alert alert-secondary mt-2" style="background: linear-gradient(to top right, rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.03), rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.15))">
                <div class="d-flex flex-row justify-content-between align-items-center">
                    <p class="fs-4 fw-bold text-white">${event.label}</p>
                    <p class="fw-bold text-white">${formatTimestamp(event.date)}</p>
                    <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#saveEventModal" style="background-color: rgba(200,200,200,.3)" onclick="updateEventSaveModal('${event.id}')">Edit Event</button>
                </div>
                <p class="fs-5 text-white">${event.description.length > 0? event.description : "No description given"}</p>
            </div>
            `;
        });

        if(memberDetails.events.length === 0){
            content = "<p class='text-center mt-3'>No events added.</p>";
        }

        document.querySelector("#events-container").innerHTML = content;
    }

    function updateEventModal(){
        const notIncludedContainer = document.querySelector("#event-list-not-included");
        const includedContainer = document.querySelector("#event-list-included");
        let notIncluded = "", included = "";

        eventList.forEach((event) => {
            let element = `<button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2" onclick="toggleEvent('${event.id}')">
                            <p class="mb-0 fw-bold ms-2">${event.label}</p>
                            <div class="d-flex justify-content-start gap-2 align-items-center">
                                <p class="mb-0">${formatTimestamp(event.date)}</p>
                                <div style="height: 30px; width:30px; background-color: rgb(${event.color.red}, ${event.color.green}, ${event.color.blue})"></div>
                            </div>
                        </button>`;

            if(memberDetails.events.some(mem => mem.id === event.id)){
                included += element;
            }else{
                notIncluded += element;
            }
        });
        notIncludedContainer.innerHTML = notIncluded;
        includedContainer.innerHTML = included;
    }

    function toggleEvent(id){
        const data = {
            memberId: memberDetails.id,
            eventId: id
        }
        let errorIcon = document.querySelector("#error-icon");
        let toastId = createToast("Toggling Event");
        postData("/api/interpersonal/event/change-member", data)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to delete member";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
            });
    }


    function updateGroups(){
        let content = `<option value="">None</option>`;

        enums.groups.forEach((group) => {
            content += `<option value="${group.id}">${group.name}</option>`;
        });

        document.querySelector("#group-form").innerHTML = content;
    }

    function modalSaveEval(){
        const idField = document.querySelector("#id-evaluation-modal").value;
        let id = null;

        let spinner = document.querySelector("#loading-spinner");
        spinner.classList.add("d-block");
        spinner.classList.remove("d-none");
        let errorIcon = document.querySelector("#error-icon");

        if(idField.length > 0){
            id = idField;
        }
        let data = {
            "id": id,
            "timestamp": document.querySelector("#date-form-modal").value,
            "cscore": document.querySelector("#cScore-form-modal").value,
            "note": document.querySelector("#note-form-modal").value,
            "memberId": document.querySelector("#id-form").value
        };

        let toastId = createToast("Saving Evaluation");
        postData("/api/interpersonal/evaluation/save", data)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to save evaluation";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
                spinner.classList.remove("d-block");
                spinner.classList.add("d-none");

                document.querySelector("#id-evaluation-modal").value = "";
            });
    }

    function deleteMember(){
        let id = memberDetails.id;

        let spinner = document.querySelector("#loading-spinner");
        spinner.classList.add("d-block");
        spinner.classList.remove("d-none");
        let errorIcon = document.querySelector("#error-icon");

        let toastId = createToast("Deleting Member");
        postData("/api/interpersonal/member/delete", id)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to delete member";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
                spinner.classList.remove("d-block");
                spinner.classList.add("d-none");

                document.querySelector("#id-evaluation-modal").value = "";

                window.location.href = "/interpersonal/new";
            });
    }

    function deleteEvaluation(id){
        let toastId = createToast("Delete Evaluation");
        postData("/api/interpersonal/evaluation/delete", id)
            .then((message) => {
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .then(refresh);
    }

    function renderOverviewTab(){
        if(memberDetails.fullTimeline == null || memberDetails.mostRecentEval == null){
            document.querySelector("#member-chips").innerHTML = `
            <div class="alert alert-primary mx-3" role="alert">
              <h4 class="text-center fw-bold mb-0">Add evaluations to see stats</h4>
            </div>
            `;
            return;
        }
        let noteContent = "";

        // General Information
        document.querySelector("#overview-name").textContent = `${memberDetails.firstName} ${memberDetails.middleName} ${memberDetails.lastName}`;
        document.querySelector("#overview-description").textContent = `${memberDetails.description? memberDetails.description : "No description provided"}`;
        document.querySelector("#overview-group").src = memberDetails.group? `/api/interpersonal/group/image/${memberDetails.group.id}`: "/icons/NoGroup.svg";

        memberDetails.fullTimeline.forEach((evaluation) => {
            if(evaluation.note.length > 0){
                noteContent += `
                <div class="d-flex justify-content-start alert alert-secondary mb-2">
                    <p class="mb-0 fw-bold">${formatDate(evaluation.timestamp)}</p>
                    <p class="mb-0 mx-3" style="color: ${getColorGradient(evaluation.cscore, -100, 100)}">${evaluation.cscore}</p>
                    <p class="mb-0">${evaluation.note}</p>
                </div>
                `;
            }
        });

        document.querySelector("#note-list-home").innerHTML = noteContent;

        let rhBackground;
        if(memberDetails.mostRecentEval.cscore > 100 || memberDetails.mostRecentEval.cscore < -100){
            rhBackground = "light";
        }else if(memberDetails.mostRecentEval.cscore >= 99){
            rhBackground = "primary";
        }else if(memberDetails.mostRecentEval.cscore >= 80){
            rhBackground = "info";
        }else if(memberDetails.mostRecentEval.cscore >= 30){
            rhBackground = "success";
        }else if(memberDetails.mostRecentEval.cscore >= -30){
            rhBackground = "warning";
        }else{
            rhBackground = "danger";
        }

        let sortedEditCounters = memberList.map((m) => m.editCount).sort((a, b) => a - b);
        let lowestEditCount = 0, highestEditCount = 0, medianEditCount = 0, medianEditIndex = 0, highestEditIndex = 0, selectedEditIndex = 0, editBackground="secondary";
        if(sortedEditCounters.length > 3){
            lowestEditCount = sortedEditCounters[0];
            highestEditCount = sortedEditCounters[sortedEditCounters.length-1];
            medianEditCount = sortedEditCounters[Math.floor(sortedEditCounters.length / 2)];
            medianEditIndex = sortedEditCounters.indexOf(medianEditCount);
            highestEditIndex = memberList.length;
            selectedEditIndex = sortedEditCounters.indexOf(memberDetails.editCount);
            if(memberDetails.editCount === sortedEditCounters[sortedEditCounters.length-1]){
                editBackground = "primary";
            }else if(memberDetails.editCount === sortedEditCounters[0]){
                editBackground = "danger";
            }else if(memberDetails.editCount > medianEditCount){
                editBackground = "success";
            }else if(memberDetails.editCount < medianEditCount){
                editBackground = "warning";
            }else{
                editBackground = "info";
            }
        }

        let memberChipHTML = `
            <div class="col-12 col-lg-3">
                <div class="alert alert-${rhBackground}">
                    <div class="d-flex flex-col w-100">
                        <div class="d-flex flex-row align-items-start justify-content-between w-100">
                            <h6 class="text-center fw-bold">Current Evaluation</h6>
                            <p class="text-end fs-2 mb-0" style="margin-top: -10px">${memberDetails.mostRecentEval.cscore}</p>
                        </div>
                    </div>
                    <div class="w-100 position-relative">
                        <img src="/icons/Arrow.svg" class="square-image position-absolute" style="width: 15px; transform: translate(-50%, 0%); left: ${memberDetails.mostRecentEval.cscore/2 + 50}%" alt="arrow" />
                    </div>
                    <div class="bg-${rhBackground} w-100 mt-4" style="height: 10px;"></div>
                    <div class="w-100 position-relative">
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: 0">-100</p>
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: 50%">0</p>
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: 100%">100</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-3">
                <div class="alert alert-secondary">
                    <h6 class="text-center fw-bold">cScore Entries</h6>
                    <p class="text-center fs-2 mb-0">${memberDetails.fullTimeline.length}</p>
                </div>
            </div>
            <div class="col-12 col-lg-3">
                <div class="alert alert-${editBackground}">
                    <div class="d-flex flex-col w-100">
                        <div class="d-flex flex-row align-items-start justify-content-between w-100">
                            <h6 class="text-center fw-bold">Member Edits</h6>
                            <p class="text-end fs-2 mb-0" style="margin-top: -10px">${memberDetails.editCount}</p>
                        </div>
                    </div>
                    <div class="w-100 position-relative">
                        <img src="/icons/Arrow.svg" class="square-image position-absolute" style="width: 15px; transform: translate(-50%, 0%); left: ${(selectedEditIndex/highestEditIndex) * 100}%" alt="arrow" />
                    </div>
                    <div class="bg-${editBackground} w-100 mt-4" style="height: 10px;"></div>
                    <div class="w-100 position-relative">
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: 0">${lowestEditCount}</p>
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: ${(medianEditIndex/highestEditIndex) * 100}%">${medianEditCount}</p>
                        <p class="text-muted position-absolute m-0" style="font-size: 10px; transform: translate(-50%, 0%); left: 100%">${highestEditCount}</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-3">
                <div class="alert alert-secondary">
                    <h6 class="text-center fw-bold">Record Age</h6>
                    <p class="text-center fs-2 mb-0">${timeSince(memberDetails.created)}</p>
                </div>
            </div>
            `;

        document.querySelector("#member-chips").innerHTML = memberChipHTML;
    }

    function renderInfoTab(){
        document.querySelector("#fnf").value = memberDetails.firstName;
        document.querySelector("#lnf").value = memberDetails.lastName;
        document.querySelector("#mnf").value = memberDetails.middleName;
        document.querySelector("#relationf").value = memberDetails.relationship;
        document.querySelector("#sexf").value = memberDetails.sex;
        document.querySelector("#sexualityf").value = memberDetails.sexuality;
        document.querySelector("#mbp").value = memberDetails.personality;
        document.querySelector("#fcf").value = memberDetails.favoriteColor;
        document.querySelector("#amf").value = memberDetails.ageMet;
        document.querySelector("#bdf").value = new Date(memberDetails.birthday).toISOString().slice(0, 10);
        document.querySelector("#df").value = memberDetails.description;

        document.querySelector("#archive-member-check").checked = memberDetails.archive;
        document.querySelector("#archive-label").textContent = (memberDetails.archive? "Archived" : "Archive Member")
        document.querySelector("#score-hold-check").checked = memberDetails.scoreHold;
        document.querySelector("#hold-label").textContent = (memberDetails.scoreHold? "On Hold" : "Hold Member")
    }

    function scoreHold(){
        memberDetails.scoreHold = !memberDetails.scoreHold;
        saveMember();
    }

    function archive(){
        memberDetails.archive = !memberDetails.archive;
        saveMember();
    }
    function saveMember(){
        const formData = new FormData();
        const imageFile = document.getElementById('pfp-file').files[0];
        formData.append('image', imageFile);
        formData.append('id', memberDetails.id);
        formData.append('firstName', document.querySelector("#fnf").value);
        formData.append('lastName', document.querySelector("#lnf").value);
        formData.append('middleName', document.querySelector("#mnf").value);
        formData.append('relationship', document.querySelector("#relationf").value);
        formData.append('sex', document.querySelector("#sexf").value);
        formData.append('sexuality', document.querySelector("#sexualityf").value);
        formData.append('personality', document.querySelector("#mbp").value);
        formData.append('favoriteColor', document.querySelector("#fcf").value);
        formData.append('ageMet', document.querySelector("#amf").value);
        formData.append('birthday', document.querySelector("#bdf").value);
        formData.append('description', document.querySelector("#df").value);
        formData.append('group', document.querySelector("#group-form").value);

        formData.append('archive', memberDetails.archive);
        formData.append('scoreHold', memberDetails.scoreHold);

        let button = document.querySelector("#submit-button");
        button.disabled = true;
        button.classList.remove("btn-primary");
        button.classList.add("btn-disabled");
        button.textContent = "Saving...";

        let toastId = createToast("Saving Member Details");
        postDataWithFile("/api/interpersonal/member/save", formData)
            .then((message) => {
                message.json()
                    .then(messageData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(messageData.severity) + messageData.message;
                        document.getElementById(`${toastId}-title`).innerText =  messageData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "green";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .then(refresh)
            .finally(() => {
                button.disabled = false;
                button.classList.remove("btn-disabled");
                button.classList.add("btn-primary");
                button.textContent = "Submit";
            });
    }

    function renderMemberSelect(members){
        let HTMLContent = ``;
        members.forEach((member) => {
            HTMLContent += `
                <option value="${member.id}">${member.firstName} ${member.lastName}</option>
            `;
        });
        document.querySelector("#member-select").innerHTML = HTMLContent;
    }

    function renderBadges(){
        let relationshipIcon = document.querySelector("#relation-icon");
        if(memberDetails.relationship.length > 0){
            relationshipIcon.src = "/icons/relations/" + memberDetails.relationship + ".svg";
        }else{
            relationshipIcon.src = "/icons/Unknown.svg";
        }

        let sexIcon = document.querySelector("#sex-icon");
        if(memberDetails.sex.length > 0){
            sexIcon.src = "/icons/sex/" + memberDetails.sex + ".svg";
        }else{
            sexIcon.src = "/icons/Unknown.svg";
        }

        let sexualityIcon = document.querySelector("#orientation-icon");
        if(memberDetails.sex.length > 0){
            sexualityIcon.src = "/icons/sexuality/" + memberDetails.sexuality + ".svg";
        }else{
            sexualityIcon.src = "/icons/Unknown.svg";
        }
    }

    function renderEvaluationTable(){
        let tableHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Timestamp</th>
                    <th scope="col">cScore</th>
                    <th scope="col">Note</th>
                    <th scope="col">Edit</th>
                    <th scope="col">Duplicate</th>
                    <th scope="col">Delete</th>
                </tr>
            </thead>
            <tbody>
        `;

        const beforeFilterEnable = document.querySelector("#before-checkbox-filter-modal").checked;
        const beforeForm = new Date(document.querySelector("#before-form-filter-modal").value);
        const afterFilterEnable = document.querySelector("#after-checkbox-filter-modal").checked;
        const afterForm = new Date(document.querySelector("#after-form-filter-modal").value);
        const filterByKeywordEnable = document.querySelector("#keyword-filter-modal").value.length > 0;
        const noteHas = document.querySelector("#keyword-filter-modal").value;


        if(memberDetails.fullTimeline == null){return;}

        memberDetails.fullTimeline.forEach((eval) => {
            if((!beforeFilterEnable || beforeForm > new Date(eval.timestamp)) && (!afterFilterEnable || afterForm < new Date(eval.timestamp)) && (!filterByKeywordEnable || eval.note.includes(noteHas))){
                tableHTML += `
                <tr id="${eval.id}">
                    <th>${formatTimestamp(eval.timestamp)}</th>
                    <th>${eval.cscore}</th>
                    <th>${eval.note}</th>
                    <th><button class="btn btn-secondary" onclick="updateModal(false, '${eval.id}')" data-bs-toggle="modal" data-bs-target="#addEvalModal">Edit</button></th>
                    <th><button class="btn btn-secondary" onclick="updateModal(true, '${eval.id}')" data-bs-toggle="modal" data-bs-target="#addEvalModal">Duplicate</button></th>
                    <th><button class="btn btn-danger bevel-sm" onclick="deleteEvaluation('${eval.id}')">Delete</button></th>
                </tr>
            `;
            }
        });

        tableHTML +="</tbody></table>";
        document.querySelector("#eval-table-container").innerHTML = tableHTML;
    }

    function changeUser(){
        document.querySelector("#id-form").value = document.querySelector("#member-select").value;
        refresh();
    }

    function updateModal(isNew = true, id = ""){
        if(id === ""){
            document.querySelector("#aemt").textContent = "New Evaluation";
            document.querySelector("#cScore-form-modal").value = "";
            document.querySelector("#note-form-modal").value = "";
            document.querySelector("#id-evaluation-modal").value = "";
            document.getElementById('date-form-modal').value = new Date().toISOString().slice(0, 16);
        }else{
            const eval = memberDetails.fullTimeline.find(eval => eval.id === id);

            const parsedDate = new Date(eval.timestamp);
            const localDate = new Date(parsedDate.getTime() - parsedDate.getTimezoneOffset() * 60000);
            const formattedDate = localDate.toISOString().slice(0, 16); // Format as "YYYY-MM-DDTHH:MM"

            document.getElementById('date-form-modal').value = formattedDate;
            document.querySelector("#cScore-form-modal").value = eval.cscore;
            document.querySelector("#note-form-modal").value = eval.note;

            if(isNew){
                document.querySelector("#aemt").textContent = "Duplicate Evaluation";
                document.querySelector("#id-evaluation-modal").value = "";
            }else{
                document.querySelector("#aemt").textContent = "Edit Evaluation";
                document.querySelector("#id-evaluation-modal").value = id;
            }
        }
    }

    function updateEvalChart() {
        let newScores = { data: [] };

        if (memberDetails.fullTimeline == null) {
            return;
        }

        // Update chart data
        memberDetails.fullTimeline.forEach((eval) => {
            newScores.data.push({ x: new Date(eval.timestamp), y: eval.cscore });
        });

        // Update datasets
        evalChartEval.data.datasets.pop();
        evalChartEval.data.datasets.push(newScores);

        evalChartEvalHome.data.datasets.pop();
        evalChartEvalHome.data.datasets.push(newScores);

        // Clear existing annotations
        evalChartEval.options.plugins.annotation.annotations = [];
        evalChartEvalHome.options.plugins.annotation.annotations = [];

        // Add new annotations based on memberDetails.events
        if (memberDetails.events) {
            const newAnnotations = memberDetails.events.map((event, index) => ({
                type: 'line',
                xScaleID: 'x',
                xMin: event.date,
                xMax: event.date,
                borderColor: `rgba(${event.color.red}, ${event.color.green}, ${event.color.blue}, 1)`,
                borderWidth: 2,
                label: {
                    content: event.label,
                    display: true,
                    position: 'start',
                    backgroundColor: `rgba(${event.color.red}, ${event.color.green}, ${event.color.blue}, 0.8)`,
                    color: 'white',
                    yAdjust: -10
                },
                click: function(e) {
                    updateEventSaveModal(event.id);
                    let myModal = new bootstrap.Modal(document.getElementById('saveEventModal'));
                    myModal.show();
                },
                enter: function(e) {
                    let content = `
                    <div class="d-flex flex-row justify-content-between align-items-center">
                        <p class="fs-5 fw-bold text-center">${event.label}</p>
                        <p class="fw-bold text-center">${formatTimestamp(event.date)}</p>
                        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#saveEventModal" style="background-color: rgba(200,200,200,.3)" onclick="updateEventSaveModal('${event.id}')">Edit Event</button>
                    </div>
                    ${event.description.length > 0? "<p class='fs-5'>" + event.description + "</p>" : "<p class='text-center fs-5'>No description given</p>"}</p>
                    `;

                    document.querySelector("#event-info-1").innerHTML = content;
                    document.querySelector("#event-info-2").innerHTML = content;

                    document.querySelector("#event-info-1").style.background = `linear-gradient(to top right, rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.03), rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.15))`;
                    document.querySelector("#event-info-2").style.background = `linear-gradient(to top right, rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.03), rgb(${event.color.red}, ${event.color.green}, ${event.color.blue},.15))`;
                },
            }));

            // Apply annotations to both charts
            evalChartEval.options.plugins.annotation.annotations = newAnnotations;
            evalChartEvalHome.options.plugins.annotation.annotations = newAnnotations;
        }

        // Update both charts
        evalChartEval.update();
        evalChartEvalHome.update();
    }

    function updateEventSaveModal(id){
        const event = eventList.find(g => g.id === id);
        document.querySelector("#saveEventModalTitle").textContent = "Edit Event Details";
        document.querySelector("#event-id-form").value =  event.id;
        document.querySelector("#event-label-form").value = event.label;
        document.querySelector("#event-description-form").value = event.description;
        document.querySelector("#event-date-form").value = event.date;
        document.querySelector("#event-red-form").value = event.color.red;
        document.querySelector("#event-green-form").value = event.color.green;
        document.querySelector("#event-blue-form").value = event.color.blue;
        updateEventColorPreview();
    }

    document.querySelector("#event-red-form").addEventListener('input', function() {
        updateEventColorPreview();
    });
    document.querySelector("#event-green-form").addEventListener('input', function() {
        updateEventColorPreview();
    });
    document.querySelector("#event-blue-form").addEventListener('input', function() {
        updateEventColorPreview();
    });

    function updateEventColorPreview(){
        const color = "rgb(" + document.querySelector("#event-red-form").value + "," + document.querySelector("#event-green-form").value + "," + document.querySelector("#event-blue-form").value + ")";
        console.log(color);
        document.querySelector("#event-color-preview").style.backgroundColor = color;
    }

    function modalSaveEvent(){
        const formData = {
            id: document.querySelector("#event-id-form").value,
            label: document.querySelector("#event-label-form").value,
            description: document.querySelector("#event-description-form").value,
            date: document.querySelector("#event-date-form").value,
            red: document.querySelector("#event-red-form").value,
            green: document.querySelector("#event-green-form").value,
            blue: document.querySelector("#event-blue-form").value
        };

        let toastId = createToast("Saving Event");
        postData("/api/interpersonal/event/save", formData)
            .then((message) => {
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-title`).innerText =  message.title;
                document.getElementById(`${toastId}-loading`).style.color = "green";
            })
            .catch((response) => {
                console.log(response);
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to connect to Polariscope Online Services";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {refresh()});
    }

    function createEvalChart(){
        let canvas = document.querySelector("#evaluation-history-chart");
        let scores = {
            datasets: [{ data: [] }]
        };

        evalChartEval = new Chart(canvas, {
            type: 'line',
            data: scores,
            options: {
                aspectRatio: 5,
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            drag: {
                                enabled: true
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x'
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MM/dd/yyyy'
                            }
                        }
                    }
                }
            }
        });

        let canvas2 = document.querySelector("#evaluation-history-chart-home");
        evalChartEvalHome = new Chart(canvas2, {
            type: 'line',
            data: scores,
            options: {
                aspectRatio: 3,
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            drag: {
                                enabled: true
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x'
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'MM/dd/yyyy',
                            displayFormats: {
                                day: 'MM/dd/yyyy'
                            }
                        }
                    }
                }
            }
        });
    }

    // Network
    function renderNetwork(){
        cy.nodes().remove();
        let memberId = document.querySelector("#id-form").value;

        // User
        cy.add({
            group: 'nodes',
            data: {
                id: memberDetails.id,
                name: document.querySelector("#graph-checkbox-labels").checked? memberDetails.firstName + " " + memberDetails.lastName : "",
                img: `/api/interpersonal/member/profile-image/${memberDetails.id}`,
                imgOpacity: document.querySelector("#graph-checkbox-img").checked? "1" : "0",
                opacity: 1,
                shape: shapeMap(memberDetails.sex),
                color: getColorGradient((memberDetails.mostRecentEval === undefined ||  memberDetails.mostRecentEval.cscore === null? "#333" : memberDetails.mostRecentEval.cscore), -100, 100)
            }
        });

        // All Connections
        memberRelationships.filter((r) => r.self.id === memberId).forEach((r) => {
            let member = memberList.find((m) => m.id === r.other.id);
            cy.add({
                group: 'nodes',
                data: {
                    id: r.other.id,
                    name: document.querySelector("#graph-checkbox-labels").checked? member.firstName + " " + member.lastName : "",
                    img: `/api/interpersonal/member/profile-image/${member.id}`,
                    imgOpacity: document.querySelector("#graph-checkbox-img").checked? "1" : "0",
                    opacity: 1,
                    shape: shapeMap(member.sex),
                    color: '#6d6d6d'
                }
            });
        });

        // Connections
        memberRelationships.filter((r) => Math.abs(r.health) >= document.querySelector("#graph-range-show").value).filter((r) => r.self.id === memberId || r.other.id === memberId).forEach((relationship) => {
            let person1 = cy.filter('node[id = "' + relationship.self.id + '"]');
            let person2 = cy.filter('node[id = "' + relationship.other.id + '"]');
            if(person1.length > 0 && person2.length > 0){
                cy.add({
                    group: 'edges',
                    data: {
                        id: relationship.id,
                        source: relationship.self.id,
                        target: relationship.other.id,
                        color: getColorGradient(relationship.health, -100, 100),
                        opacity: Math.min(Math.max((Math.abs(relationship.health) / 100), .05), .9)
                    }
                });
            }
        });

        // Layout
        setTimeout(()=>{
            let main_layout = cy.nodes().layout({
                name: 'random',
                fit: true,
                animation: false
            });

            main_layout.run();
        }, 500);
    }

    function shapeMap(sex){
        if(sex === "MALE"){
            return "rectangle";
        }else if(sex === "FEMALE"){
            return "ellipse";
        }else{
            return "triangle";
        }
    }


    function renderModal(selfId, otherId){
        let self = memberList.find((member) => member.id === selfId);
        let other = memberList.find((member) => member.id === otherId);
        let relationship = memberRelationships.find((rel) => rel.id===`${self.id}${other.id}`);

        document.querySelector("#modal-person-1-name").textContent = self.firstName + " " + self.lastName;
        document.querySelector("#modal-person-2-name").textContent = other.firstName + " " + other.lastName;

        if(relationship){
            document.querySelector("#modal-relationship-health").textContent = `Relationship Health: ${relationship.health}`;
            document.querySelector("#modal-relationship-type").textContent = `Relationship Type: ${relationship.type}`;

            document.querySelector("#modal-relationship-health-form").value = relationship.health;
            document.querySelector("#modal-relationship-type-form").value = relationship.type;

            document.querySelector("#modal-relationship-description").value = relationship.description;
        }else{
            document.querySelector("#modal-relationship-health").textContent = "No relationship recorded";
            document.querySelector("#modal-relationship-type").textContent = "";

            document.querySelector("#modal-relationship-health-form").value = 0;
            //document.querySelector("#modal-relationship-type-form").value = "";

            document.querySelector("#modal-relationship-description").value = "";
        }

        document.querySelector("#modal-person-1-img").src = `/api/interpersonal/member/profile-image/${self.id}`;
        document.querySelector("#modal-person-2-img").src = `/api/interpersonal/member/profile-image/${other.id}`;

        document.querySelector("#modal-self").value = self.id;
        document.querySelector("#modal-other").value = other.id;
    }

    // Graph callbacks
    cy.on('dbltap', 'edge', (event) => {
        renderModal(event.target._private.data.source, event.target._private.data.target);
        let myModal = new bootstrap.Modal(document.getElementById('relationship-modal'));
        myModal.show();
    });

    function saveRelationship(next=false){
        let data = {
            self: document.querySelector("#modal-self").value,
            other: document.querySelector("#modal-other").value,
            health: document.querySelector("#modal-relationship-health-form").value,
            type: document.querySelector("#modal-relationship-type-form").value,
            description: document.querySelector("#modal-relationship-description").value
        }

        let errorIcon = document.querySelector("#error-icon");
        let toastId = createToast("Updating Relationship");
        postData("/api/interpersonal/relationship/save", data)
            .then((message) => {
                console.log(message);
                document.getElementById(`${toastId}-title`).innerText = message.title;
                document.getElementById(`${toastId}-body`).innerText = getIcon(message.severity) + message.message;
                document.getElementById(`${toastId}-loading`).style.color = "green";

                if(next){
                    let otherIndex = allMembers.findIndex((m) => m.id === data.other)
                    let nextIndex = (otherIndex+1) % allMembers.length;
                    if(allMembers[nextIndex].id === data.self){
                        nextIndex = (otherIndex+2) % allMembers.length;
                    }
                    renderModal(data.self, allMembers[nextIndex].id);
                }
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        document.getElementById(`${toastId}-body`).innerText = getIcon(errorData.severity) + errorData.message;
                        document.getElementById(`${toastId}-title`).innerText = errorData.title;
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                        document.getElementById(`${toastId}-body`).innerText = "Unable to edit relationship";
                        document.getElementById(`${toastId}-title`).innerText = "Error";
                        document.getElementById(`${toastId}-loading`).style.color = "red";
                    });
            })
            .finally(() => {
                refresh();
            });
    }

    // network settings
    function updateToleranceIndicator(){
        document.querySelector('#tolerance-indicator').textContent = document.querySelector('#graph-range-show').value;
    }

    document.querySelector("#graph-range-show").value = 0;

</script>
</body>
</html>