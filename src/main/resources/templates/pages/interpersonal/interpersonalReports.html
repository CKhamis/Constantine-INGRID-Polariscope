<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="~{components/Header :: head('Analysis')}"></head>
<body class="bg-2 text-1" data-bs-theme="dark">
<div th:replace="~{components/Navigation :: vertical}"></div>
<main class="bg-2" style="margin-left: 60px; height: 100vh;">
    <nav class="container-fluid pt-2 position-sticky top-0 border-bottom" style="background: linear-gradient(#222, #2c2c2c);">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="col-md-10 d-flex flex-row align-items-center justify-content-start">
                <img class="square-image me-2" style="height: 40px; width: 40px" alt="Analysis image" th:src="@{/icons/Reports.svg}">
                <h1 class="fw-bold">Polariscope Analysis</h1>
            </div>
            <div class="spinner-border d-none" role="status" id="loading-spinner">
                <span class="visually-hidden">Loading...</span>
            </div>
            <img src="/icons/Error.svg" id="error-icon" alt="error" class="square-image d-none" height="32px" width="32px" />
        </div>
        <div class="mb-0 pb-0 d-flex justify-content-between align-items-end">
            <ul class="nav nav-underline" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active fs-3 p-0" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-tab-pane" type="button" role="tab" aria-controls="overview-tab-pane" aria-selected="true">Overview</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fs-3 p-0" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-tab-pane" type="button" role="tab" aria-controls="details-tab-pane" aria-selected="false">Details</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link fs-3 p-0" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-tab-pane" type="button" role="tab" aria-controls="custom-tab-pane" aria-selected="false">Custom</button>
                </li>
            </ul>
            <div class="d-flex flex-row align-content-center justify-content-end pb-2 gap-3">
                <div class="mb-2 bg-light-subtle d-flex justify-content-center align-items-center p-2" role="button" onclick="refresh()">
                    <img class="square-image" src="/icons/Plus.svg" alt="New Report" style="width: 20px;">
                </div>
                <div class="mb-2 bg-light-subtle d-flex justify-content-center align-items-center p-2" role="button" onclick="refresh()">
                    <img class="square-image" src="/icons/Refresh.svg" alt="New Report" style="width: 20px;">
                </div>
            </div>
        </div>
    </nav>

</main>
<div th:replace="~{components/External :: external}"></div>
<div th:replace="~{components/Formatting :: date-formatting}"></div>
<div th:replace="~{components/Network :: network}"></div>
<div th:replace="~{components/Network :: data-upload}"></div>
<div th:replace="~{components/Toast :: toast}"></div>
<div th:replace="~{components/External :: tooltips}"></div>

<script>
    let quarterlyReports = [];

    refresh();

    function refresh(){
        let spinner = document.querySelector("#loading-spinner");
        let errorIcon = document.querySelector("#error-icon");
        spinner.classList.add("d-block");
        spinner.classList.remove("d-none");

        const quarterlyFetch = fetch("/api/interpersonal/reports/quarterly", {});

        Promise.all([quarterlyFetch])
            .then(responses => {
                return Promise.all(responses);
            })
            .then(data => {
                return Promise.all([data[0].json()]);
            })
            .then(data => {
                console.log(data);

                if(data[0]){
                    quarterlyReports = data[0];
                }
                renderChips();
            })
            .catch((response) => {
                errorIcon.classList.add("d-block");
                errorIcon.classList.remove("d-none");
                response.json()
                    .then(errorData => {
                        console.log(errorData.message);
                    })
                    .catch(error => {
                        console.error("Error parsing error response:", error);
                    });
            })
            .finally(() => {
                spinner.classList.remove("d-block");
                spinner.classList.add("d-none");
            });

        function renderChips(){
            let buttonHTML = "";
            quarterlyReports.forEach((report, index) => {
                buttonHTML += `<button type="button" class="btn btn-dark text-nowrap active" data-bs-toggle="button" id="report-button-${index}">${formatDate(report.startDate)} - ${formatDate(report.endDate)}</button>`;
            });
            document.querySelector("#report-toggles").innerHTML = buttonHTML;
        }
    }
</script>
</body>
</html>